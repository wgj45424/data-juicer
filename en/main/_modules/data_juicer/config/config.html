
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data_juicer.config.config &#8212; Data Juicer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=34d13042" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/data_juicer/config/config';</script>
    <script src="../../../_static/sidebar.js?v=3fc1065c"></script>
    <script src="../../../_static/switcher-mobile.js?v=07875724"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="../../../_static/icon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search docs..."
         aria-label="Search docs..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/icon.png" class="logo__image only-light" alt=""/>
    <img src="../../../_static/icon.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Data Juicer</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/en/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: en">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">en</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../../../en/main/_modules/data_juicer/config/config.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            English
          </a>
        
          
          
          <a href="../../../../../zh_CN/main/_modules/data_juicer/config/config_ZH.html"
             class="dropdown-item "
             role="menuitem"
             >
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../../../main/_modules/data_juicer/config/config.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/en/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: en">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">en</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../../../en/main/_modules/data_juicer/config/config.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            English
          </a>
        
          
          
          <a href="../../../../../zh_CN/main/_modules/data_juicer/config/config_ZH.html"
             class="dropdown-item "
             role="menuitem"
             >
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../../../main/_modules/data_juicer/config/config.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">data_juicer.config.config</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for data_juicer.config.config</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.util</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">argparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArgumentError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jsonargparse</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ActionConfigFile</span><span class="p">,</span>
    <span class="n">ArgumentParser</span><span class="p">,</span>
    <span class="n">Namespace</span><span class="p">,</span>
    <span class="n">dict_to_namespace</span><span class="p">,</span>
    <span class="n">namespace_to_dict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jsonargparse._typehints</span><span class="w"> </span><span class="kn">import</span> <span class="n">ActionTypeHint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">jsonargparse.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClosedUnitInterval</span><span class="p">,</span> <span class="n">NonNegativeInt</span><span class="p">,</span> <span class="n">PositiveInt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.ops.base_op</span><span class="w"> </span><span class="kn">import</span> <span class="n">OPERATORS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.ops.op_fusion</span><span class="w"> </span><span class="kn">import</span> <span class="n">FUSION_STRATEGIES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.constant</span><span class="w"> </span><span class="kn">import</span> <span class="n">RAY_JOB_ENV_VAR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.logger_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.mm_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpecialTokens</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.ray_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_ray_mode</span>

<span class="n">global_cfg</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">global_parser</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="timing_context">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.timing_context">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">timing_context</span><span class="p">(</span><span class="n">description</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="c1"># Use a consistent format that won&#39;t be affected by logger reconfiguration</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2"> took </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_generate_module_name</span><span class="p">(</span><span class="n">abs_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a module name based on the absolute path of the file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">abs_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="load_custom_operators">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.load_custom_operators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_custom_operators</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dynamically load custom operator modules or packages in the specified path.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">abs_path</span><span class="p">):</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">_generate_module_name</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">existing_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Module &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&#39; already loaded from &#39;</span><span class="si">{</span><span class="n">existing_path</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Conflict detected while loading &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">abs_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create spec for &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
                <span class="c1"># register the module first to avoid recursive import issues</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39; as &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">abs_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abs_path</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Package directory &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39; must contain __init__.py&quot;</span><span class="p">)</span>
            <span class="n">package_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">package_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="n">existing_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Package &#39;</span><span class="si">{</span><span class="n">package_name</span><span class="si">}</span><span class="s2">&#39; already loaded from &#39;</span><span class="si">{</span><span class="n">existing_path</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Conflict detected while loading &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="n">original_sys_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>
                <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">package_name</span><span class="p">)</span>
                <span class="c1"># record the loading path of the package (for subsequent conflict detection)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span><span class="o">.</span><span class="n">__loaded_from__</span> <span class="o">=</span> <span class="n">abs_path</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading package &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">original_sys_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path &#39;</span><span class="si">{</span><span class="n">abs_path</span><span class="si">}</span><span class="s2">&#39; is neither a file nor a directory&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="init_configs">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.init_configs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_configs</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">which_entry</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">load_configs_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    initialize the jsonargparse parser and parse configs from one of:</span>
<span class="sd">        1. POSIX-style commands line args;</span>
<span class="sd">        2. config files in yaml (json and jsonnet supersets);</span>
<span class="sd">        3. environment variables</span>
<span class="sd">        4. hard-coded defaults</span>

<span class="sd">    :param args: list of params, e.g., [&#39;--config&#39;, &#39;cfg.yaml&#39;], default None.</span>
<span class="sd">    :param which_entry: which entry to init configs (executor/analyzer)</span>
<span class="sd">    :param load_configs_only: whether to load the configs only, not including backing up config files, display them, and</span>
<span class="sd">        setting up logger.</span>
<span class="sd">    :return: a global cfg object used by the DefaultExecutor or Analyzer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Total config initialization time&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Initializing parser&quot;</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="p">(</span><span class="n">default_env</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_config_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>

            <span class="c1"># required but mutually exclusive args group</span>
            <span class="n">required_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">required_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ActionConfigFile</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a dj basic configuration file.&quot;</span>
            <span class="p">)</span>
            <span class="n">required_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--auto&quot;</span><span class="p">,</span>
                <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Weather to use an auto analyzing &quot;</span>
                <span class="s2">&quot;strategy instead of a specific data &quot;</span>
                <span class="s2">&quot;recipe. If a specific config file is &quot;</span>
                <span class="s2">&quot;given by --config arg, this arg is &quot;</span>
                <span class="s2">&quot;disabled. Only available for Analyzer.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--auto_num&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">PositiveInt</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The number of samples to be analyzed &quot;</span> <span class="s2">&quot;automatically. It&#39;s 1000 in default.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--hpo_config&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a configuration file when using auto-HPO tool.&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--data_probe_algo&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Sampling algorithm to use. Options are &quot;uniform&quot;, &#39;</span>
                <span class="s1">&#39;&quot;frequency_specified_field_selector&quot;, or &#39;</span>
                <span class="s1">&#39;&quot;topk_specified_field_selector&quot;. Default is &quot;uniform&quot;. Only &#39;</span>
                <span class="s2">&quot;used for dataset sampling&quot;</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--data_probe_ratio&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">ClosedUnitInterval</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The ratio of the sample size to the original dataset size. &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;Default is 1.0 (no sampling). Only used for dataset sampling&quot;</span><span class="p">,</span>
                <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># basic global paras with extended type hints</span>
            <span class="c1"># e.g., files can be mode include flags</span>
            <span class="c1"># &quot;fr&quot;: &quot;path to a file that exists and is readable&quot;)</span>
            <span class="c1"># &quot;fc&quot;: &quot;path to a file that can be created if it does not exist&quot;)</span>
            <span class="c1"># &quot;dw&quot;: &quot;path to a directory that exists and is writeable&quot;)</span>
            <span class="c1"># &quot;dc&quot;: &quot;path to a directory that can be created if it does not exist&quot;)</span>
            <span class="c1"># &quot;drw&quot;: &quot;path to a directory that exists and is readable and writeable&quot;)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--project_name&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;hello_world&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of your data process project.&quot;</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--executor_type&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="s2">&quot;ray_partitioned&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of executor, support &quot;default&quot;, &quot;ray&quot;, or &quot;ray_partitioned&quot;.&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--dataset_path&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to datasets with optional weights(0.0-1.0), 1.0 as &quot;</span>
                <span class="s2">&quot;default. Accepted format:&lt;w1&gt; dataset1-path &lt;w2&gt; dataset2-path &quot;</span>
                <span class="s2">&quot;&lt;w3&gt; dataset3-path ...&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--dataset&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">Dict</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Dataset setting to define local/remote datasets; could be a &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;dict or a list of dicts; refer to &quot;</span>
                <span class="s2">&quot;https://datajuicer.github.io/data-juicer/en/main/docs/DatasetCfg.html for more &quot;</span>
                <span class="s2">&quot;detailed examples&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--generated_dataset_config&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Configuration used to create a dataset. &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;The dataset will be created from this configuration if provided. &quot;</span>
                <span class="s2">&quot;It must contain the `type` field to specify the dataset name.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--validators&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of validators to apply to the dataset. Each validator &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;must have a `type` field specifying the validator type.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--work_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a work directory to store outputs during Data-Juicer &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;running. It&#39;s the directory where export_path is at in default.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_path&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;./outputs/hello_world/hello_world.jsonl&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to export and save the output processed dataset. The &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;directory to store the processed dataset will be the work &quot;</span>
                <span class="s2">&quot;directory of this process.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_type&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The export format type. If it&#39;s not specified, Data-Juicer will parse from the export_path. The &quot;</span>
                <span class="s2">&quot;supported types can be found in Exporter._router() for standalone mode and &quot;</span>
                <span class="s2">&quot;RayExporter._SUPPORTED_FORMATS for ray mode&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_shard_size&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">NonNegativeInt</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shard size of exported dataset in Byte. In default, it&#39;s 0, &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;which means export the whole dataset into only one file. If &quot;</span>
                <span class="s2">&quot;it&#39;s set a positive number, the exported dataset will be split &quot;</span>
                <span class="s2">&quot;into several sub-dataset shards, and the max size of each shard &quot;</span>
                <span class="s2">&quot;won&#39;t larger than the export_shard_size&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_in_parallel&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to export the result dataset in parallel to a single &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;file, which usually takes less time. It only works when &quot;</span>
                <span class="s2">&quot;export_shard_size is 0, and its default number of processes is &quot;</span>
                <span class="s2">&quot;the same as the argument np. **Notice**: If it&#39;s True, &quot;</span>
                <span class="s2">&quot;sometimes exporting in parallel might require much more time &quot;</span>
                <span class="s2">&quot;due to the IO blocking, especially for very large datasets. &quot;</span>
                <span class="s2">&quot;When this happens, False is a better choice, although it takes &quot;</span>
                <span class="s2">&quot;more time.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_extra_args&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Other optional arguments for exporting in dict. For example, the key mapping info for exporting &quot;</span>
                <span class="s2">&quot;the WebDataset format.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_aws_credentials&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Export-specific AWS credentials for S3 export. If export_path is S3 and this is not provided, &quot;</span>
                <span class="s2">&quot;an error will be raised. Should contain aws_access_key_id, aws_secret_access_key, aws_region, &quot;</span>
                <span class="s2">&quot;and optionally aws_session_token and endpoint_url.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--keep_stats_in_res_ds&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to keep the computed stats in the result dataset. If &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;it&#39;s False, the intermediate fields to store the stats &quot;</span>
                <span class="s2">&quot;computed by Filters will be removed. Default: False.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--keep_hashes_in_res_ds&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to keep the computed hashes in the result dataset. If &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;it&#39;s False, the intermediate fields to store the hashes &quot;</span>
                <span class="s2">&quot;computed by Deduplicators will be removed. Default: False.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--np&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">PositiveInt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of processes to process dataset.&quot;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--text_keys&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Key name of field where the sample texts to be processed, e.g., &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;`text`, `text.instruction`, `text.output`, ... Note: currently, &quot;</span>
                <span class="s2">&quot;we support specify only ONE key for each op, for cases &quot;</span>
                <span class="s2">&quot;requiring multiple keys, users can specify the op multiple &quot;</span>
                <span class="s2">&quot;times.  We will only use the first key of `text_keys` when you &quot;</span>
                <span class="s2">&quot;set multiple keys.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--image_key&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;images&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Key name of field to store the list of sample image paths.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--image_bytes_key&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;image_bytes&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Key name of field to store the list of sample image bytes.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--image_special_token&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The special token that represents an image in the text. In &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s1">&#39;default, it</span><span class="se">\&#39;</span><span class="s1">s &quot;&lt;__dj__image&gt;&quot;. You can specify your own special&#39;</span>
                <span class="s2">&quot; token according to your input dataset.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--audio_key&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;audios&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Key name of field to store the list of sample audio paths.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--audio_special_token&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">audio</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The special token that represents an audio in the text. In &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s1">&#39;default, it</span><span class="se">\&#39;</span><span class="s1">s &quot;&lt;__dj__audio&gt;&quot;. You can specify your own special&#39;</span>
                <span class="s2">&quot; token according to your input dataset.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--video_key&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;videos&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Key name of field to store the list of sample video paths.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--video_special_token&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">video</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The special token that represents a video in the text. In &quot;</span>
                <span class="s1">&#39;default, it</span><span class="se">\&#39;</span><span class="s1">s &quot;&lt;__dj__video&gt;&quot;. You can specify your own special&#39;</span>
                <span class="s2">&quot; token according to your input dataset.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--eoc_special_token&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">SpecialTokens</span><span class="o">.</span><span class="n">eoc</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The special token that represents the end of a chunk in the &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s1">&#39;text. In default, it</span><span class="se">\&#39;</span><span class="s1">s &quot;&lt;|__dj__eoc|&gt;&quot;. You can specify your &#39;</span>
                <span class="s2">&quot;own special token according to your input dataset.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--suffixes&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Suffixes of files that will be find and loaded. If not set, we &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;will find all suffix files, and select a suitable formatter &quot;</span>
                <span class="s2">&quot;with the most files as default.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--turbo&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable Turbo mode to maximize processing speed when batch size &quot;</span> <span class="s2">&quot;is 1.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--skip_op_error&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip errors in OPs caused by unexpected invalid samples.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--use_cache&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use the cache management of huggingface datasets. It &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;might take up lots of disk space when using cache&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--ds_cache_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cache dir for HuggingFace datasets. In default it&#39;s the same &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;as the environment variable `HF_DATASETS_CACHE`, whose default &quot;</span>
                <span class="s1">&#39;value is usually &quot;~/.cache/huggingface/datasets&quot;. If this &#39;</span>
                <span class="s2">&quot;argument is set to a valid path by users, it will override the &quot;</span>
                <span class="s2">&quot;default cache dir. Modifying this arg might also affect the other two&quot;</span>
                <span class="s2">&quot; paths to store downloaded and extracted datasets that depend on &quot;</span>
                <span class="s2">&quot;`HF_DATASETS_CACHE`&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--cache_compress&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The compression method of the cache file, which can be&quot;</span>
                <span class="s1">&#39;specified in [&quot;gzip&quot;, &quot;zstd&quot;, &quot;lz4&quot;]. If this parameter is&#39;</span>
                <span class="s2">&quot;None, the cache file will not be compressed.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--open_monitor&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to open the monitor to trace resource utilization for &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;each OP during data processing. It&#39;s True in default.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--use_checkpoint&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use the checkpoint management to save the latest &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;version of dataset to work dir when processing. Rerun the same &quot;</span>
                <span class="s2">&quot;config will reload the checkpoint and skip ops before it. Cache &quot;</span>
                <span class="s2">&quot;will be disabled when it is true . If args of ops before the &quot;</span>
                <span class="s2">&quot;checkpoint are changed, all ops will be rerun from the &quot;</span>
                <span class="s2">&quot;beginning.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Enhanced checkpoint configuration for PartitionedRayExecutor</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--checkpoint.enabled&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable enhanced checkpointing for PartitionedRayExecutor&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--checkpoint.strategy&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;every_n_ops&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;every_op&quot;</span><span class="p">,</span> <span class="s2">&quot;every_partition&quot;</span><span class="p">,</span> <span class="s2">&quot;every_n_ops&quot;</span><span class="p">,</span> <span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;disabled&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Checkpoint strategy: every_n_ops (default, balanced), every_op (max protection), &quot;</span>
                <span class="s2">&quot;manual (after specific ops), disabled (best performance)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--checkpoint.n_ops&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of operations between checkpoints for every_n_ops strategy. &quot;</span>
                <span class="s2">&quot;Default 5 balances fault tolerance with Ray optimization.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--checkpoint.op_names&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of operation names to checkpoint for manual strategy&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Event logging configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--event_logging.enabled&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable event logging for job tracking and resumption&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Logging configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--max_log_size_mb&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum log file size in MB before rotation&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--backup_count&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of backup log files to keep&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Storage configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--event_log_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Separate directory for event logs (fast storage)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--checkpoint_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Separate directory for checkpoints (large storage)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Job management</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--job_id&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Custom job ID for resumption and tracking. If not provided, a unique ID will be auto-generated.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--temp_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the temp directory to store intermediate caches when &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;cache is disabled. In default it&#39;s None, so the temp dir will &quot;</span>
                <span class="s2">&quot;be specified by system. NOTICE: you should be caution when &quot;</span>
                <span class="s2">&quot;setting this argument because it might cause unexpected program &quot;</span>
                <span class="s2">&quot;behaviors when this path is set to an unsafe directory.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--open_tracer&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to open the tracer to trace samples changed during &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;process. It might take more time when opening tracer.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--op_list_to_trace&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which ops will be traced by tracer. If it&#39;s empty, all ops in &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;cfg.process will be traced. Only available when open_tracer is &quot;</span>
                <span class="s2">&quot;true.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--trace_num&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of samples extracted by tracer to show the dataset &quot;</span>
                <span class="s2">&quot;difference before and after a op. Only available when &quot;</span>
                <span class="s2">&quot;open_tracer is true.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--trace_keys&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of field names to include in trace output. If set, the &quot;</span>
                <span class="s2">&quot;specified fields&#39; values will be included in each trace entry. &quot;</span>
                <span class="s2">&quot;Only available when open_tracer is true.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--open_insight_mining&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to open insight mining to trace the OP-wise stats/tags &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;changes during process. It might take more time when opening &quot;</span>
                <span class="s2">&quot;insight mining.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--op_list_to_mine&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Which OPs will be applied on the dataset to mine the insights &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;in their stats changes. Only those OPs that produce stats or &quot;</span>
                <span class="s2">&quot;meta are valid. If it&#39;s empty, all OPs that produce stats and &quot;</span>
                <span class="s2">&quot;meta will be involved. Only available when filter_list_to_mine &quot;</span>
                <span class="s2">&quot;is true.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--op_fusion&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to fuse operators that share the same intermediate &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;variables automatically. Op fusion might reduce the memory &quot;</span>
                <span class="s2">&quot;requirements slightly but speed up the whole process.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--fusion_strategy&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;probe&quot;</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;OP fusion strategy. Support [&quot;greedy&quot;, &quot;probe&quot;] now. &quot;greedy&quot; &#39;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;means keep the basic OP order and put the fused OP to the last &quot;</span>
                <span class="s1">&#39;of each fused OP group. &quot;probe&quot; means Data-Juicer will probe &#39;</span>
                <span class="s2">&quot;the running speed for each OP at the beginning and reorder the &quot;</span>
                <span class="s2">&quot;OPs and fused OPs according to their probed speed (fast to &quot;</span>
                <span class="s1">&#39;slow). It</span><span class="se">\&#39;</span><span class="s1">s &quot;probe&quot; in default.&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--adaptive_batch_size&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to use adaptive batch sizes for each OP according to &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;the probed results. It&#39;s False in default.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--process&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of several operators with their arguments, these ops will &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;be applied to dataset in order&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--percentiles&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Percentiles to analyze the dataset distribution. Only used in &quot;</span> <span class="s2">&quot;Analysis.&quot;</span><span class="p">,</span>  <span class="c1"># noqa: E251</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--export_original_dataset&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;whether to export the original dataset with stats. If you only &quot;</span>  <span class="c1"># noqa: E251</span>
                <span class="s2">&quot;need the stats of the dataset, setting it to false could speed &quot;</span>
                <span class="s2">&quot;up the exporting..&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--save_stats_in_one_file&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to save all stats to only one file. Only used in &quot;</span> <span class="s2">&quot;Analysis.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ray_address&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The address of the Ray cluster.&quot;</span><span class="p">)</span>

            <span class="c1"># Partitioning configuration for PartitionedRayExecutor</span>
            <span class="c1"># Support both flat and nested partition configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--partition_size&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of samples per partition for PartitionedRayExecutor (legacy flat config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--max_partition_size_mb&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum partition size in MB for PartitionedRayExecutor (legacy flat config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--preserve_intermediate_data&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Preserve intermediate data for debugging (legacy flat config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># partition configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--partition.mode&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Partition mode: manual (specify num_of_partitions) or auto (use partition size optimizer)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--partition.num_of_partitions&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of partitions for manual mode (ignored in auto mode)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--partition.target_size_mb&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Target partition size in MB for auto mode (128, 256, 512, or 1024). &quot;</span>
                <span class="s2">&quot;Controls how large each partition should be. Smaller = more checkpoints &amp; better recovery, &quot;</span>
                <span class="s2">&quot;larger = less overhead. Default 256MB balances memory safety and efficiency.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Resource optimization configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--resource_optimization.auto_configure&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable automatic optimization of partition size, worker count, and other resource-dependent settings (nested resource_optimization config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Intermediate storage configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.preserve_intermediate_data&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Preserve intermediate data for debugging (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.cleanup_temp_files&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clean up temporary files after processing (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.cleanup_on_success&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clean up intermediate files even on successful completion (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.retention_policy&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;keep_all&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;keep_all&quot;</span><span class="p">,</span> <span class="s2">&quot;keep_failed_only&quot;</span><span class="p">,</span> <span class="s2">&quot;cleanup_all&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;File retention policy (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.max_retention_days&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum retention days for files (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Intermediate storage format configuration</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.format&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span> <span class="s2">&quot;arrow&quot;</span><span class="p">,</span> <span class="s2">&quot;jsonl&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Storage format for checkpoints and intermediate data (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.compression&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span>
                <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;snappy&quot;</span><span class="p">,</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">],</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Compression format for storage files (nested intermediate_storage config)&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--intermediate_storage.write_partitions&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to write intermediate partition files to disk (nested intermediate_storage config). Set to false for better performance when intermediate files aren&#39;t needed.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--partition_dir&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory to store partition files. Supports </span><span class="si">{work_dir}</span><span class="s2"> placeholder. If not set, defaults to </span><span class="si">{work_dir}</span><span class="s2">/partitions.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--custom-operator-paths&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Paths to custom operator scripts or directories.&quot;</span>
            <span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--debug&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to run in debug mode.&quot;</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                <span class="s2">&quot;--auto_op_parallelism&quot;</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to automatically set operator parallelism.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Filter out non-essential arguments for initial parsing</span>
            <span class="n">essential_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                    <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># Handle --help, --config, and --auto in first pass</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--help&quot;</span><span class="p">:</span>
                        <span class="n">essential_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--config&quot;</span><span class="p">:</span>
                        <span class="n">essential_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="c1"># The next argument must be the config file path</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                            <span class="n">essential_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--auto&quot;</span><span class="p">:</span>
                        <span class="n">essential_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Parse essential arguments first</span>
            <span class="n">essential_cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">essential_args</span><span class="p">)</span>

            <span class="c1"># Now add remaining arguments based on essential config</span>
            <span class="n">used_ops</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">essential_cfg</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="c1"># Load config file to determine which operators are used</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">essential_cfg</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">config_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">used_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;process&quot;</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">[</span><span class="s2">&quot;process&quot;</span><span class="p">]:</span>
                            <span class="n">used_ops</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Add remaining arguments</span>
                <span class="n">ops_sorted_by_types</span> <span class="o">=</span> <span class="n">sort_op_by_types_and_names</span><span class="p">(</span><span class="n">OPERATORS</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

                <span class="c1"># Only add arguments for used operators</span>
                <span class="n">_collect_config_info_from_class_docs</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">op_name</span><span class="p">,</span> <span class="n">op_class</span><span class="p">)</span> <span class="k">for</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">op_class</span> <span class="ow">in</span> <span class="n">ops_sorted_by_types</span> <span class="k">if</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">used_ops</span><span class="p">],</span> <span class="n">parser</span>
                <span class="p">)</span>

            <span class="c1"># Parse all arguments</span>
            <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Parsing arguments&quot;</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">executor_type</span> <span class="o">==</span> <span class="s2">&quot;ray&quot;</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">RAY_JOB_ENV_VAR</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">custom_operator_paths</span><span class="p">:</span>
                    <span class="n">load_custom_operators</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">custom_operator_paths</span><span class="p">)</span>

                <span class="c1"># check the entry</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.core.analyzer</span><span class="w"> </span><span class="kn">import</span> <span class="n">Analyzer</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">which_entry</span><span class="p">,</span> <span class="n">Analyzer</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">auto</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;--auto argument can only be used for analyzer!&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Initializing setup from config&quot;</span><span class="p">):</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">init_setup_from_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">load_configs_only</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Updating operator process&quot;</span><span class="p">):</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">update_op_process</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">used_ops</span><span class="p">)</span>

        <span class="c1"># Validate config for resumption if job_id is provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_configs_only</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
            <span class="c1"># Check if this is a resumption attempt by looking for existing job directory</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîç Checking for job resumption: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="n">validate_config_for_resumption</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># New job, set flag to True</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># copy the config file into the work directory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_configs_only</span><span class="p">:</span>
            <span class="n">config_backup</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="c1"># show the final config tables before the process started</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">load_configs_only</span><span class="p">:</span>
            <span class="n">display_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">global_cfg</span><span class="p">,</span> <span class="n">global_parser</span>
        <span class="n">global_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="n">global_parser</span> <span class="o">=</span> <span class="n">parser</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;In DEBUG mode.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="update_ds_cache_dir_and_related_vars">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.update_ds_cache_dir_and_related_vars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_ds_cache_dir_and_related_vars</span><span class="p">(</span><span class="n">new_ds_cache_path</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>

    <span class="c1"># update the HF_DATASETS_CACHE</span>
    <span class="n">config</span><span class="o">.</span><span class="n">HF_DATASETS_CACHE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">new_ds_cache_path</span><span class="p">)</span>
    <span class="c1"># and two more PATHS that depend on HF_DATASETS_CACHE</span>
    <span class="c1"># - path to store downloaded datasets (e.g. remote datasets)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_DOWNLOADED_DATASETS_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HF_DATASETS_CACHE</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">DOWNLOADED_DATASETS_DIR</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">DOWNLOADED_DATASETS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_DOWNLOADED_DATASETS_PATH</span><span class="p">)</span>
    <span class="c1"># - path to store extracted datasets (e.g. xxx.jsonl.zst)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_EXTRACTED_DATASETS_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_DOWNLOADED_DATASETS_PATH</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">EXTRACTED_DATASETS_DIR</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">EXTRACTED_DATASETS_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">DEFAULT_EXTRACTED_DATASETS_PATH</span><span class="p">)</span></div>



<div class="viewcode-block" id="init_setup_from_cfg">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.init_setup_from_cfg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">init_setup_from_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">load_configs_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do some extra setup tasks after parsing config file or command line.</span>

<span class="sd">    1. create working directory and logs directory</span>
<span class="sd">    2. update cache directory</span>
<span class="sd">    3. update checkpoint and `temp_dir` of tempfile</span>

<span class="sd">    :param cfg: an original cfg</span>
<span class="sd">    :param cfg: an updated cfg</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Handle S3 paths differently from local paths</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
        <span class="c1"># For S3 paths, keep as-is (don&#39;t use os.path.abspath)</span>
        <span class="c1"># If work_dir is not provided, use a default local directory for logs/checkpoints</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use a default local work directory for S3 exports</span>
            <span class="c1"># This is where logs, checkpoints, and other local artifacts will be stored</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;./outputs&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default work_dir [</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">] for S3 export_path [</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For local paths, convert to absolute path</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="p">)</span>

    <span class="c1"># Call resolve_job_directories to finalize all job-related paths</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">resolve_job_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">resolve_job_directories</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">load_configs_only</span><span class="p">:</span>
        <span class="c1"># For S3 paths, use a simplified export path for log filename</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">):</span>
            <span class="c1"># Extract bucket and key from S3 path for log filename</span>
            <span class="n">s3_path_parts</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;s3://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">export_rel_path</span> <span class="o">=</span> <span class="n">s3_path_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s3_path_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">s3_path_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">export_rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">export_path</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="c1"># Ensure event_log_dir (logs/) exists - this is where logs are actually saved</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">event_log_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">event_log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logfile_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;export_</span><span class="si">{</span><span class="n">export_rel_path</span><span class="si">}</span><span class="s2">_time_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.txt&quot;</span>
        <span class="n">setup_logger</span><span class="p">(</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">event_log_dir</span><span class="p">,</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">logfile_name</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
            <span class="n">redirect</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;executor_type&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># check and get dataset dir</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset_path&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dataset_path config is set and a valid local path&quot;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">dataset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset_path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dataset_path config is empty; dataset is present&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;dataset_path [</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dataset_path&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">] is not a valid &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;local path, AND dataset is not present. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Please check and retry, otherwise we &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;will treat dataset_path as a remote dataset or a &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;mixture of several datasets.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># check number of processes np</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.resource_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">cpu_count</span>

    <span class="n">sys_cpu_count</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">np</span> <span class="o">&gt;</span> <span class="n">sys_cpu_count</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Number of processes `np` is set as [</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">np</span><span class="si">}</span><span class="s2">], which &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;is larger than the cpu count [</span><span class="si">{</span><span class="n">sys_cpu_count</span><span class="si">}</span><span class="s2">]. Due &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;to the data processing of Data-Juicer is a &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;computation-intensive task, we recommend to set it to&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; a value &lt;= cpu count. Set it to [</span><span class="si">{</span><span class="n">sys_cpu_count</span><span class="si">}</span><span class="s2">] &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;here.&quot;</span>
        <span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">np</span> <span class="o">=</span> <span class="n">sys_cpu_count</span>

    <span class="c1"># whether or not to use cache management</span>
    <span class="c1"># disabling the cache or using checkpoint explicitly will turn off the</span>
    <span class="c1"># cache management.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_cache&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_checkpoint&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cache management of datasets is disabled.&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">disable_caching</span>

        <span class="n">disable_caching</span><span class="p">()</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">use_cache</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># disabled cache compression when cache is disabled</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">cache_compress</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Disable cache compression due to disabled cache.&quot;</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">cache_compress</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># when disabling cache, enable the temp_dir argument</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set temp directory to store temp files to &quot;</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">temp_dir</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">temp_dir</span>

    <span class="c1"># The checkpoint mode is not compatible with op fusion for now.</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;op_fusion&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">use_checkpoint</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">fusion_strategy</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fusion_strategy</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fusion_strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FUSION_STRATEGIES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported OP fusion strategy [</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">fusion_strategy</span><span class="si">}</span><span class="s2">]. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Should be one of </span><span class="si">{</span><span class="n">FUSION_STRATEGIES</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="c1"># update huggingface datasets cache directory only when ds_cache_dir is set</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ds_cache_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Set dataset cache directory to </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">ds_cache_dir</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;using the ds_cache_dir argument, which is &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">HF_DATASETS_CACHE</span><span class="si">}</span><span class="s2"> before based on the env &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;variable HF_DATASETS_CACHE.&quot;</span>
        <span class="p">)</span>
        <span class="n">update_ds_cache_dir_and_related_vars</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">ds_cache_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">ds_cache_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">HF_DATASETS_CACHE</span><span class="p">)</span>

    <span class="c1"># add all filters that produce stats</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">load_ops_with_stats_meta</span><span class="p">()</span>

    <span class="c1"># Apply text_key modification during initializing configs</span>
    <span class="c1"># users can freely specify text_key for different ops using `text_key`</span>
    <span class="c1"># otherwise, set arg text_key of each op to text_keys</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">text_keys</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text_keys&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">text_keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">text_key</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">text_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text_key</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">text_keys</span>

    <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_special_token&quot;</span><span class="p">,</span> <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
    <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">audio</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audio_special_token&quot;</span><span class="p">,</span> <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">audio</span><span class="p">)</span>
    <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video_special_token&quot;</span><span class="p">,</span> <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">video</span><span class="p">)</span>
    <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">eoc</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eoc_special_token&quot;</span><span class="p">,</span> <span class="n">SpecialTokens</span><span class="o">.</span><span class="n">eoc</span><span class="p">)</span>

    <span class="n">op_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;text_key&quot;</span><span class="p">:</span> <span class="n">text_key</span><span class="p">,</span>
        <span class="s2">&quot;image_key&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_key&quot;</span><span class="p">,</span> <span class="s2">&quot;images&quot;</span><span class="p">),</span>
        <span class="s2">&quot;audio_key&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audio_key&quot;</span><span class="p">,</span> <span class="s2">&quot;audios&quot;</span><span class="p">),</span>
        <span class="s2">&quot;video_key&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video_key&quot;</span><span class="p">,</span> <span class="s2">&quot;videos&quot;</span><span class="p">),</span>
        <span class="s2">&quot;image_bytes_key&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image_bytes_key&quot;</span><span class="p">,</span> <span class="s2">&quot;image_bytes&quot;</span><span class="p">),</span>
        <span class="s2">&quot;turbo&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;turbo&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;skip_op_error&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;skip_op_error&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;auto_op_parallelism&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auto_op_parallelism&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ray_mode</span><span class="p">():</span>
        <span class="n">op_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;num_proc&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;np&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)})</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">update_op_attr</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="n">op_attrs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="load_ops_with_stats_meta">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.load_ops_with_stats_meta">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_ops_with_stats_meta</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pkgutil</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">data_juicer.ops.filter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">djfilter</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">NON_STATS_FILTERS</span><span class="p">,</span> <span class="n">TAGGING_OPS</span>

    <span class="n">stats_filters</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="n">filter_name</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">djfilter</span><span class="o">.</span><span class="n">__path__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NON_STATS_FILTERS</span><span class="o">.</span><span class="n">modules</span>
    <span class="p">]</span>
    <span class="n">meta_ops</span> <span class="o">=</span> <span class="p">[{</span><span class="n">op_name</span><span class="p">:</span> <span class="p">{}}</span> <span class="k">for</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">TAGGING_OPS</span><span class="o">.</span><span class="n">modules</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">stats_filters</span> <span class="o">+</span> <span class="n">meta_ops</span></div>



<div class="viewcode-block" id="update_op_attr">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.update_op_attr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_op_attr</span><span class="p">(</span><span class="n">op_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">attr_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">attr_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op_list</span>
    <span class="n">updated_op_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">op_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">attr_dict</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attr_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">op</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">updated_op_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated_op_list</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_collect_config_info_from_class_docs</span><span class="p">(</span><span class="n">configurable_ops</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add ops and its params to parser for command line with optimized performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Collecting operator configuration info&quot;</span><span class="p">):</span>
        <span class="n">op_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add arguments for all provided operators</span>
        <span class="k">for</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">op_class</span> <span class="ow">in</span> <span class="n">configurable_ops</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_class_arguments</span><span class="p">(</span>
                <span class="n">theclass</span><span class="o">=</span><span class="n">op_class</span><span class="p">,</span> <span class="n">nested_key</span><span class="o">=</span><span class="n">op_name</span><span class="p">,</span> <span class="n">fail_untyped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">instantiate</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">op_params</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span>

        <span class="k">return</span> <span class="n">op_params</span>


<div class="viewcode-block" id="sort_op_by_types_and_names">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.sort_op_by_types_and_names">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sort_op_by_types_and_names</span><span class="p">(</span><span class="n">op_name_classes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split ops items by op type and sort them to sub-ops by name, then concat</span>
<span class="sd">    together.</span>

<span class="sd">    :param op_name_classes: a list of op modules</span>
<span class="sd">    :return: sorted op list , each item is a pair of op_name and</span>
<span class="sd">        op_class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">timing_context</span><span class="p">(</span><span class="s2">&quot;Sorting operators by types and names&quot;</span><span class="p">):</span>
        <span class="n">mapper_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;mapper&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">filter_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">deduplicator_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;deduplicator&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">selector_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;selector&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">grouper_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;grouper&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">aggregator_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">op_name_classes</span> <span class="k">if</span> <span class="s2">&quot;aggregator&quot;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>
        <span class="n">ops_sorted_by_types</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">mapper_ops</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filter_ops</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deduplicator_ops</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">selector_ops</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grouper_ops</span><span class="p">)</span>
            <span class="o">+</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aggregator_ops</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ops_sorted_by_types</span></div>



<div class="viewcode-block" id="update_op_process">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.update_op_process">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_op_process</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">used_ops</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update operator process configuration with optimized performance.</span>

<span class="sd">    Args:</span>
<span class="sd">        cfg: Configuration namespace</span>
<span class="sd">        parser: Argument parser</span>
<span class="sd">        used_ops: Set of operator names that are actually used in the config</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">used_ops</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">used_ops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">OPERATORS</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Get command line args for operators in one pass</span>
    <span class="n">option_in_commands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">full_option_in_commands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">op_name</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">used_ops</span><span class="p">:</span>
                <span class="n">option_in_commands</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>
                <span class="n">full_option_in_commands</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">process</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create direct mapping of operator names to their configs</span>
    <span class="n">op_configs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">process</span><span class="p">:</span>
        <span class="n">op_configs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="c1"># Process each used operator</span>
    <span class="n">temp_cfg</span> <span class="o">=</span> <span class="n">cfg</span>
    <span class="n">op_name_count</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">used_ops</span><span class="p">:</span>
        <span class="n">op_config</span> <span class="o">=</span> <span class="n">op_configs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>
        <span class="n">op_config_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">op_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option_in_commands</span><span class="p">:</span>
            <span class="c1"># Update op params if set</span>
            <span class="k">if</span> <span class="n">op_config</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">op_c</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">:</span>
                    <span class="n">temp_cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">merge_config</span><span class="p">(</span><span class="n">dict_to_namespace</span><span class="p">({</span><span class="n">op_name</span><span class="p">:</span> <span class="n">op_c</span><span class="p">}),</span> <span class="n">temp_cfg</span><span class="p">)</span>
                    <span class="n">oc</span> <span class="o">=</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">temp_cfg</span><span class="p">)[</span><span class="n">op_name</span><span class="p">]</span>
                    <span class="n">op_config_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>
                <span class="n">temp_cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">merge_config</span><span class="p">(</span><span class="n">dict_to_namespace</span><span class="p">({</span><span class="n">op_name</span><span class="p">:</span> <span class="n">op_config_list</span><span class="p">}),</span> <span class="n">temp_cfg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove args that will be overridden by command line</span>
            <span class="k">if</span> <span class="n">op_config</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">op_c</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">full_option</span> <span class="ow">in</span> <span class="n">full_option_in_commands</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">full_option</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">op_c</span><span class="p">:</span>
                            <span class="n">op_c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">temp_cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">merge_config</span><span class="p">(</span><span class="n">dict_to_namespace</span><span class="p">({</span><span class="n">op_name</span><span class="p">:</span> <span class="n">op_c</span><span class="p">}),</span> <span class="n">temp_cfg</span><span class="p">)</span>
                    <span class="n">oc</span> <span class="o">=</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">temp_cfg</span><span class="p">)[</span><span class="n">op_name</span><span class="p">]</span>
                    <span class="n">op_config_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oc</span><span class="p">)</span>
                <span class="n">temp_cfg</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">merge_config</span><span class="p">(</span><span class="n">dict_to_namespace</span><span class="p">({</span><span class="n">op_name</span><span class="p">:</span> <span class="n">op_config_list</span><span class="p">}),</span> <span class="n">temp_cfg</span><span class="p">)</span>

        <span class="c1"># Update op params</span>
        <span class="n">internal_op_para</span> <span class="o">=</span> <span class="n">temp_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>
        <span class="c1"># Update or add the operator to process list</span>
        <span class="k">if</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">op_configs</span><span class="p">:</span>
            <span class="c1"># Update existing operator</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op_in_process</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">process</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">internal_op_para</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">op_in_process</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">op_name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">op_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_name_count</span><span class="p">:</span>
                            <span class="n">op_name_count</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">op_name_count</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">cfg</span><span class="o">.</span><span class="n">process</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">op_name</span><span class="p">:</span> <span class="p">(</span>
                                <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">internal_op_para</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="k">else</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">internal_op_para</span><span class="p">[</span><span class="n">op_name_count</span><span class="p">[</span><span class="n">op_name</span><span class="p">]])</span>
                            <span class="p">)</span>
                        <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add new operator</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">op_name</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">internal_op_para</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">internal_op_para</span><span class="p">)})</span>

    <span class="c1"># Optimize type checking</span>
    <span class="n">recognized_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">action</span><span class="o">.</span><span class="n">dest</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">ActionTypeHint</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1"># check the op params via type hint</span>
    <span class="n">temp_parser</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>

    <span class="n">temp_args</span> <span class="o">=</span> <span class="n">namespace_to_arg_list</span><span class="p">(</span><span class="n">temp_cfg</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="n">recognized_args</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">temp_cfg</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">temp_args</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">temp_cfg</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">temp_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--auto&quot;</span><span class="p">)</span>

    <span class="c1"># validate</span>
    <span class="n">temp_parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">temp_args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="namespace_to_arg_list">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.namespace_to_arg_list">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">namespace_to_arg_list</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">includes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">arg_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">Namespace</span><span class="p">):</span>
            <span class="n">nested_args</span> <span class="o">=</span> <span class="n">namespace_to_arg_list</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">arg_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nested_args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">concat_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">includes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">concat_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">includes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">excludes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">concat_key</span> <span class="ow">in</span> <span class="n">excludes</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;process&quot;</span><span class="p">:</span>
                <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">concat_key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">concat_key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arg_list</span></div>



<div class="viewcode-block" id="save_cli_arguments">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.save_cli_arguments">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_cli_arguments</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save CLI arguments to cli.yaml in the work directory.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;work_dir&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Get the original CLI arguments if available</span>
    <span class="n">original_args</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;_original_args&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_args</span><span class="p">:</span>
        <span class="c1"># Try to reconstruct from sys.argv if available</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="n">original_args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">original_args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No CLI arguments available to save&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Create cli.yaml in work directory</span>
    <span class="n">cli_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;cli.yaml&quot;</span><span class="p">)</span>

    <span class="c1"># Convert args to a simple format</span>
    <span class="n">cli_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">original_args</span><span class="p">}</span>

    <span class="c1"># Save as YAML</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cli_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cli_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üíæ Saved CLI arguments to: </span><span class="si">{</span><span class="n">cli_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="validate_config_for_resumption">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.validate_config_for_resumption">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_config_for_resumption</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">original_args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate that the current config matches the job&#39;s saved config for safe resumption.</span>

<span class="sd">    Does verbatim comparison between:</span>
<span class="sd">    1. Original config.yaml + cli.yaml (saved during job creation)</span>
<span class="sd">    2. Current config (from current command)</span>

<span class="sd">    Sets cfg._same_yaml_config = True/False for the executor to use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

        <span class="c1"># Find the original config file in the work directory</span>
        <span class="n">config_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.yaml&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.yml&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_files</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No config file found in work directory: </span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Find the original config.yaml (not cli.yaml)</span>
        <span class="n">original_config_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">config_file</span> <span class="ow">in</span> <span class="n">config_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config_file</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;cli.yaml&quot;</span><span class="p">:</span>
                <span class="n">original_config_file</span> <span class="o">=</span> <span class="n">config_file</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">original_config_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No original config file found in work directory: </span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 1. Direct file comparison for config files</span>
        <span class="n">current_config_file</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">config</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_config_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No current config file found&quot;</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">original_config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">original_config_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">current_config_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">current_config_content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">config_match</span> <span class="o">=</span> <span class="n">original_config_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">current_config_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># 2. Per-key comparison for CLI arguments</span>
        <span class="n">cli_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cli.yaml&quot;</span>
        <span class="n">cli_config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cli_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cli_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">cli_data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">cli_config</span> <span class="o">=</span> <span class="n">_parse_cli_to_config</span><span class="p">(</span><span class="n">cli_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;arguments&quot;</span><span class="p">,</span> <span class="p">[]))</span>

        <span class="c1"># Get current CLI arguments from the original args passed to init_configs</span>
        <span class="n">current_cli_args</span> <span class="o">=</span> <span class="n">original_args</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_cli_args</span><span class="p">:</span>
            <span class="c1"># Fallback: try to get from sys.argv</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

            <span class="n">current_cli_args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">current_cli_config</span> <span class="o">=</span> <span class="n">_parse_cli_to_config</span><span class="p">(</span><span class="n">current_cli_args</span><span class="p">)</span>

        <span class="c1"># Compare CLI arguments per key</span>
        <span class="n">cli_differences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_cli_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cli_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_cli_config</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">excluded_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;_original_args&quot;</span><span class="p">,</span> <span class="s2">&quot;backed_up_config_path&quot;</span><span class="p">,</span> <span class="s2">&quot;_same_yaml_config&quot;</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="s2">&quot;work_dir&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_cli_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">excluded_keys</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">original_value</span> <span class="o">=</span> <span class="n">cli_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">current_value</span> <span class="o">=</span> <span class="n">current_cli_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">original_value</span> <span class="o">!=</span> <span class="n">current_value</span><span class="p">:</span>
                <span class="n">cli_differences</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span> <span class="n">original_value</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="n">current_value</span><span class="p">})</span>

        <span class="n">cli_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cli_differences</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">config_match</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cli_match</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;‚ùå Config validation failed - configurations don&#39;t match:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config_match</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;   [config] Config file content differs&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cli_match</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;   [cli] CLI arguments differ:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">diff</span> <span class="ow">in</span> <span class="n">cli_differences</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">diff</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">diff</span><span class="p">[</span><span class="s1">&#39;original&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ‚Üí </span><span class="si">{</span><span class="n">diff</span><span class="p">[</span><span class="s1">&#39;current&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;üí° Use the same config file and CLI arguments for resumption&quot;</span><span class="p">)</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Config validation passed - configurations match exactly&quot;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error validating config for resumption: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">_same_yaml_config</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_parse_cli_to_config</span><span class="p">(</span><span class="n">cli_args</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse CLI arguments into config dictionary format using the global parser.</span>

<span class="sd">    This ensures proper handling of:</span>
<span class="sd">    - --key=value syntax</span>
<span class="sd">    - Arguments with spaces</span>
<span class="sd">    - Multiple values (nargs=&#39;+&#39;)</span>
<span class="sd">    - Complex type conversions</span>

<span class="sd">    Args:</span>
<span class="sd">        cli_args: List of CLI arguments to parse</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of parsed configuration values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">global_parser</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cli_args</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># If global_parser is available, use it for robust parsing</span>
    <span class="k">if</span> <span class="n">global_parser</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># For comparison purposes, we only care about override arguments, not the config file</span>
            <span class="c1"># Filter out --config and --auto since they&#39;re handled separately</span>
            <span class="n">filtered_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cli_args</span><span class="p">):</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">cli_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--config&quot;</span> <span class="ow">or</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;--auto&quot;</span><span class="p">:</span>
                    <span class="c1"># Skip --config/--auto and its value (if any)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cli_args</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cli_args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                    <span class="c1"># Keep other flags</span>
                    <span class="n">filtered_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">filtered_args</span><span class="p">:</span>
                    <span class="c1"># Keep values that follow flags</span>
                    <span class="n">filtered_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Skip positional arguments (e.g., pytest test names)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># If no override args, return empty dict</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_args</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="c1"># Add --auto to satisfy the required argument (we&#39;ll filter it out later)</span>
            <span class="n">temp_cli_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;--auto&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">filtered_args</span>

            <span class="c1"># Use parse_known_args to handle unrecognized arguments gracefully</span>
            <span class="n">parsed_cfg</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="n">global_parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span><span class="n">temp_cli_args</span><span class="p">)</span>
            <span class="c1"># Convert to dict for comparison</span>
            <span class="n">config_dict</span> <span class="o">=</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">parsed_cfg</span><span class="p">)</span>

            <span class="c1"># Remove arguments we don&#39;t want to compare</span>
            <span class="n">config_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">config_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">config_dict</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse CLI args with global_parser: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Falling back to manual parsing.&quot;</span><span class="p">)</span>

    <span class="c1"># Fallback to improved manual parsing if parser not available</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cli_args</span><span class="p">):</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">cli_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
            <span class="c1"># Handle --key=value syntax</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                <span class="c1"># Collect all values until next flag</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cli_args</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cli_args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--&quot;</span><span class="p">):</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cli_args</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                    <span class="c1"># If multiple values, keep as list; otherwise, single value</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_parse_value</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Boolean flag (no value)</span>
                    <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a string value to its appropriate type.&quot;&quot;&quot;</span>
    <span class="c1"># Try to parse as different types</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try int first</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;e&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try float</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Return as string</span>
    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="config_backup">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.config_backup">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">config_backup</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">cfg_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Use the backed_up_config_path which should be set by resolve_job_directories</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;backed_up_config_path&quot;</span><span class="p">):</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">backed_up_config_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback: use work_dir with original filename</span>
        <span class="n">work_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span>
        <span class="n">original_config_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">)</span>
        <span class="n">target_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">original_config_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Back up the input config file [</span><span class="si">{</span><span class="n">cfg_path</span><span class="si">}</span><span class="s2">] to [</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">cfg_path</span><span class="p">,</span> <span class="n">target_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Config file [</span><span class="si">{</span><span class="n">cfg_path</span><span class="si">}</span><span class="s2">] already exists at [</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

    <span class="c1"># Also save CLI arguments</span>
    <span class="n">save_cli_arguments</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span></div>



<div class="viewcode-block" id="display_config">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.display_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">display_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">tabulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">tabulate</span>

    <span class="n">table_header</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;values&quot;</span><span class="p">]</span>

    <span class="c1"># remove ops outside the process list for better displaying</span>
    <span class="n">shown_cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">shown_cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="c1"># construct the table as 2 columns</span>
    <span class="n">config_table</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">shown_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">config_table</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">table_header</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;fancy_grid&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuration table: &quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>



<div class="viewcode-block" id="export_config">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.export_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_config</span><span class="p">(</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;yaml&quot;</span><span class="p">,</span>
    <span class="n">skip_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">skip_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">multifile</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the config object, some params are from jsonargparse</span>

<span class="sd">    :param cfg: cfg object to save (Namespace type)</span>
<span class="sd">    :param path: the save path</span>
<span class="sd">    :param format: &#39;yaml&#39;, &#39;json&#39;, &#39;json_indented&#39;, &#39;parser_mode&#39;</span>
<span class="sd">    :param skip_none: Whether to exclude entries whose value is None.</span>
<span class="sd">    :param skip_check: Whether to skip parser checking.</span>
<span class="sd">    :param overwrite: Whether to overwrite existing files.</span>
<span class="sd">    :param multifile: Whether to save multiple config files</span>
<span class="sd">        by using the __path__ metas.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># remove ops outside the process list for better displaying</span>
    <span class="n">cfg_to_export</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
    <span class="n">cfg_to_export</span> <span class="o">=</span> <span class="n">prepare_cfgs_for_export</span><span class="p">(</span><span class="n">cfg_to_export</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">global_parser</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">global_parser</span><span class="p">:</span>
        <span class="n">init_configs</span><span class="p">()</span>  <span class="c1"># enable the customized type parser</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg_to_export</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
        <span class="n">cfg_to_export</span> <span class="o">=</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">cfg_to_export</span><span class="p">)</span>
    <span class="n">global_parser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
        <span class="n">cfg</span><span class="o">=</span><span class="n">cfg_to_export</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
        <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
        <span class="n">skip_none</span><span class="o">=</span><span class="n">skip_none</span><span class="p">,</span>
        <span class="n">skip_check</span><span class="o">=</span><span class="n">skip_check</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="n">multifile</span><span class="o">=</span><span class="n">multifile</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved the configuration in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="merge_config">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.merge_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_config</span><span class="p">(</span><span class="n">ori_cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">new_cfg</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge configuration from new_cfg into ori_cfg</span>

<span class="sd">    :param ori_cfg: the original configuration object, whose type is</span>
<span class="sd">        expected as namespace from jsonargparse</span>
<span class="sd">    :param new_cfg: the configuration object to be merged, whose type is</span>
<span class="sd">        expected as dict or namespace from jsonargparse</span>

<span class="sd">    :return: cfg_after_merge</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ori_specified_op_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ori_specified_op_idx</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {op_name: op_order}</span>

        <span class="k">for</span> <span class="n">op_order</span><span class="p">,</span> <span class="n">op_in_process</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ori_cfg</span><span class="o">.</span><span class="n">process</span><span class="p">):</span>
            <span class="n">op_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op_in_process</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ori_specified_op_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>
            <span class="n">ori_specified_op_idx</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_order</span>

        <span class="k">for</span> <span class="n">new_k</span><span class="p">,</span> <span class="n">new_v</span> <span class="ow">in</span> <span class="n">new_cfg</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># merge parameters other than `cfg.process` and DJ-OPs</span>
            <span class="k">if</span> <span class="n">new_k</span> <span class="ow">in</span> <span class="n">ori_cfg</span> <span class="ow">and</span> <span class="n">new_k</span> <span class="o">!=</span> <span class="s2">&quot;process&quot;</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_k</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before merging, the cfg item is: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ori_cfg</span><span class="p">[</span><span class="n">new_k</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ori_cfg</span><span class="p">[</span><span class="n">new_k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_v</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After merging,  the cfg item is: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">new_v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># merge parameters of DJ-OPs into cfg.process</span>
                <span class="c1"># for nested style, e.g., `remove_table_text_mapper.min_col: 2`</span>
                <span class="n">key_as_groups</span> <span class="o">=</span> <span class="n">new_k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_as_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">key_as_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ori_specified_op_names</span><span class="p">:</span>
                    <span class="n">op_name</span><span class="p">,</span> <span class="n">para_name</span> <span class="o">=</span> <span class="n">key_as_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key_as_groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">op_order</span> <span class="o">=</span> <span class="n">ori_specified_op_idx</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span>
                    <span class="n">ori_cfg_val</span> <span class="o">=</span> <span class="n">ori_cfg</span><span class="o">.</span><span class="n">process</span><span class="p">[</span><span class="n">op_order</span><span class="p">][</span><span class="n">op_name</span><span class="p">][</span><span class="n">para_name</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Before merging, the cfg item is: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ori_cfg_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ori_cfg</span><span class="o">.</span><span class="n">process</span><span class="p">[</span><span class="n">op_order</span><span class="p">][</span><span class="n">op_name</span><span class="p">][</span><span class="n">para_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_v</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After merging,  the cfg item is: &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">new_v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>

        <span class="n">ori_cfg</span> <span class="o">=</span> <span class="n">init_setup_from_cfg</span><span class="p">(</span><span class="n">ori_cfg</span><span class="p">)</span>

        <span class="c1"># copy the config file into the work directory</span>
        <span class="n">config_backup</span><span class="p">(</span><span class="n">ori_cfg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ori_cfg</span>

    <span class="k">except</span> <span class="n">ArgumentError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Config merge failed&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="prepare_side_configs">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.prepare_side_configs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_side_configs</span><span class="p">(</span><span class="n">ori_config</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    parse the config if ori_config is a string of a config file path with</span>
<span class="sd">        yaml, yml or json format</span>

<span class="sd">    :param ori_config: a config dict or a string of a config file path with</span>
<span class="sd">        yaml, yml or json format</span>

<span class="sd">    :return: a config dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ori_config</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># config path</span>
        <span class="k">if</span> <span class="n">ori_config</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ori_config</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ori_config</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ori_config</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ori_config</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unrecognized config file type: [</span><span class="si">{</span><span class="n">ori_config</span><span class="si">}</span><span class="s2">]. &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;Should be one of the types [&quot;.yaml&quot;, &quot;.yml&quot;, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;&quot;.json&quot;].&#39;</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ori_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ori_config</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ori_config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized side config type: [</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ori_config</span><span class="p">)</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span></div>



<div class="viewcode-block" id="get_init_configs">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.get_init_configs">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_init_configs</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">load_configs_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    set init configs of data-juicer for cfg</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()</span>
    <span class="n">temp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;job_dj_config.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">Namespace</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">namespace_to_dict</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

    <span class="c1"># Remove internal attributes that are not part of the configuration schema</span>
    <span class="c1"># to avoid validation errors when re-initializing the config</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Remove internal attributes that are added during config processing</span>
        <span class="n">internal_attrs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;_user_provided_job_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_same_yaml_config&quot;</span><span class="p">,</span>
            <span class="s2">&quot;metadata_dir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;results_dir&quot;</span><span class="p">,</span>
            <span class="s2">&quot;event_log_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;job_summary_file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;backed_up_config_path&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">internal_attrs</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># create a temp config file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prepare_cfgs_for_export</span><span class="p">(</span><span class="n">cfg</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">inited_dj_cfg</span> <span class="o">=</span> <span class="n">init_configs</span><span class="p">([</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">temp_file</span><span class="p">],</span> <span class="n">load_configs_only</span><span class="o">=</span><span class="n">load_configs_only</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inited_dj_cfg</span></div>



<div class="viewcode-block" id="get_default_cfg">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.get_default_cfg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_default_cfg</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get default config values from config_min.yaml&quot;&quot;&quot;</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">()</span>

    <span class="c1"># Get path to config_min.yaml</span>
    <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">default_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;config_min.yaml&quot;</span><span class="p">)</span>

    <span class="c1"># Load default values from yaml</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">default_config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert to flat dictionary for namespace</span>
    <span class="n">flat_defaults</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Add other top-level keys from config_min.yaml</span>
        <span class="o">**</span><span class="n">defaults</span>
    <span class="p">}</span>

    <span class="c1"># Update cfg with defaults</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">flat_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="prepare_cfgs_for_export">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.prepare_cfgs_for_export">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_cfgs_for_export</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="c1"># 1. convert Path to str</span>
    <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
        <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]]</span>
    <span class="c1"># 2. remove level-1 op cfgs outside the process list</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="resolve_job_id">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.resolve_job_id">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_job_id</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolve or auto-generate job_id and set it on cfg.&quot;&quot;&quot;</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Track whether job_id was user-provided</span>
    <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># User explicitly provided a job_id</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;_user_provided_job_id&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># No job_id provided by user</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;_user_provided_job_id&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">short_hash</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">short_hash</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="validate_work_dir_config">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.validate_work_dir_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_work_dir_config</span><span class="p">(</span><span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate work_dir configuration to ensure {job_id} placement rules are followed.</span>

<span class="sd">    Args:</span>
<span class="sd">        work_dir: The work_dir string to validate</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If {job_id} is not at the end of the path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{job_id}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">work_dir</span><span class="p">:</span>
        <span class="c1"># Check if {job_id} is at the end of the path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">work_dir</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{job_id}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid work_dir configuration: &#39;</span><span class="se">{{</span><span class="s2">job_id</span><span class="se">}}</span><span class="s2">&#39; must be the last part of the path. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Current: &#39;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Expected format: &#39;path/to/directory/</span><span class="se">{{</span><span class="s2">job_id</span><span class="se">}}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span></div>



<div class="viewcode-block" id="resolve_job_directories">
<a class="viewcode-back" href="../../../api/data_juicer.config.config.html#data_juicer.config.resolve_job_directories">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_job_directories</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Centralize directory resolution and placeholder substitution. Assumes job_id is already set.</span>

<span class="sd">    Job Directory Rules:</span>
<span class="sd">    - If work_dir contains &#39;{job_id}&#39; placeholder, it MUST be the last part of the path</span>
<span class="sd">    - Examples:</span>
<span class="sd">      ‚úÖ work_dir: &quot;./outputs/my_project/{job_id}&quot;     # Valid</span>
<span class="sd">      ‚úÖ work_dir: &quot;/data/experiments/{job_id}&quot;        # Valid</span>
<span class="sd">      ‚ùå work_dir: &quot;./outputs/{job_id}/results&quot;        # Invalid - {job_id} not at end</span>
<span class="sd">      ‚ùå work_dir: &quot;./{job_id}/outputs/data&quot;           # Invalid - {job_id} not at end</span>

<span class="sd">    - If work_dir does NOT contain &#39;{job_id}&#39;, job_id will be appended automatically</span>
<span class="sd">    - Examples:</span>
<span class="sd">      work_dir: &quot;./outputs/my_project&quot; ‚Üí work_dir: &quot;./outputs/my_project/20250804_143022_abc123&quot;</span>

<span class="sd">    After resolution, work_dir will always include job_id at the end.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. placeholder map</span>
    <span class="n">placeholder_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>

    <span class="c1"># 2. Validate {job_id} placement in work_dir before substitution</span>
    <span class="n">original_work_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span>
    <span class="n">validate_work_dir_config</span><span class="p">(</span><span class="n">original_work_dir</span><span class="p">)</span>

    <span class="c1"># 3. substitute placeholders in all relevant paths (change-detection loop)</span>
    <span class="n">max_passes</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_passes</span><span class="p">):</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;work_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;event_log_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;checkpoint_dir&quot;</span><span class="p">,</span> <span class="s2">&quot;export_path&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_path&quot;</span><span class="p">,</span> <span class="s2">&quot;partition_dir&quot;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">placeholder_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_val</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># update placeholder_map in case work_dir or job_id changed</span>
        <span class="n">placeholder_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;work_dir&quot;</span><span class="p">:</span> <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Too many placeholder substitution passes (possible recursive placeholders?)&quot;</span><span class="p">)</span>

    <span class="c1"># 4. directory resolution</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;job_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">job_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;job_id must be set before resolving job directories.&quot;</span><span class="p">)</span>

    <span class="c1"># Ensure work_dir always includes job_id at the end</span>
    <span class="c1"># If work_dir already ends with job_id (from placeholder substitution), keep it as-is</span>
    <span class="c1"># Otherwise, append job_id automatically</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span> <span class="o">==</span> <span class="n">job_id</span><span class="p">):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">job_id</span><span class="p">)</span>

    <span class="c1"># All job-specific directories are under work_dir</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;event_log_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">event_log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;checkpoint_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;checkpoints&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;partition_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">partition_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;partitions&quot;</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">metadata_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">event_log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;events.jsonl&quot;</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">job_summary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;job_summary.json&quot;</span><span class="p">)</span>
    <span class="c1"># Set backed_up_config_path using original config filename</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">original_config_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">backed_up_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">original_config_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">backed_up_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;config.yaml&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cfg</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      ¬© Copyright 2024, Data-Juicer Team.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>

<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How-to Guide for Developers &#8212; Data Juicer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=34d13042" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/DeveloperGuide';</script>
    <script src="../_static/sidebar.js?v=3fc1065c"></script>
    <script src="../_static/switcher-mobile.js?v=07875724"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="../_static/icon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Distributed Data Processing in Data-Juicer" href="Distributed.html" />
    <link rel="prev" title="DJ_service" href="DJ_service.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search docs..."
         aria-label="Search docs..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/icon.png" class="logo__image only-light" alt=""/>
    <img src="../_static/icon.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Data Juicer</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/en/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: en">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">en</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../en/main/docs/DeveloperGuide.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            English
          </a>
        
          
          
          <a href="../../../zh_CN/main/docs/DeveloperGuide_ZH.html"
             class="dropdown-item "
             role="menuitem"
             >
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../main/docs/DeveloperGuide.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../docs_index.html">
    DOCS
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/en/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/en/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/en/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: en">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">en</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../en/main/docs/DeveloperGuide.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            English
          </a>
        
          
          
          <a href="../../../zh_CN/main/docs/DeveloperGuide_ZH.html"
             class="dropdown-item "
             role="menuitem"
             >
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../main/docs/DeveloperGuide.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="tutorial/DJ-Cookbook.html">DJ-Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial/Installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial/QuickStart.html">Quick Start</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">docs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Operators.html">Operator Schemas ÁÆóÂ≠êÊèêË¶Å</a></li>
<li class="toctree-l1"><a class="reference internal" href="DatasetCfg.html">Dataset Configuration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="BadDataExhibition.html">‚ÄúBad‚Äù Data Exhibition</a></li>
<li class="toctree-l1"><a class="reference internal" href="DJ_SORA.html">DJ-SORA</a></li>
<li class="toctree-l1"><a class="reference internal" href="DJ_service.html">DJ_service</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How-to Guide for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Distributed.html">Distributed Data Processing in Data-Juicer</a></li>
<li class="toctree-l1"><a class="reference internal" href="JobManagement.html">Job Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="PartitionAndCheckpoint.html">Partitioned Processing with Checkpointing</a></li>
<li class="toctree-l1"><a class="reference internal" href="awesome_llm_data.html">Awesome Data-Model Co-Development of MLLMs </a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">operators</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="operators/aggregator/index.html">Aggregator</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/deduplicator/index.html">Deduplicator</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/filter/index.html">Filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/mapper/index.html">Mapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/formatter/index.html">Formatter</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/grouper/index.html">Grouper</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/selector/index.html">Selector</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators/op/index.html">Op</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">demos</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../demos/README.html">Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../demos/process_video_on_ray/data/Note.html">Note for dataset path</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">tools</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../tools/distributed_deduplication/README.html">Distributed Fuzzy Deduplication Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/evaluator/README.html">Auto Evaluation Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/evaluator/gpt_eval/README.html">GPT EVAL: Evaluate your model with OpenAI API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/evaluator/recorder/README.html">Evaluation Results Recorder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fmt_conversion/README.html">Format Conversion Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fmt_conversion/multimodal/README.html">Multimodal Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/fmt_conversion/post_tuning_dialog/README.html">Post Tuning Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/humanops/README.html">Label Studio Service Utility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/mm_eval/inception_metrics/README.html">Metrics for video generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/mm_eval/vbench_metrics/README.html">VBench metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/postprocess/README.html">Postprocess tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/preprocess/README.html">Preprocess Tools</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">thirdparty</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../thirdparty/LLM_ecosystems/README.html">LLM Ecosystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thirdparty/models/README.html">Third-party Model Library</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../docs_index.html" class="nav-link">DOCS</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">How-to Guide for Developers</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="how-to-guide-for-developers">
<h1>How-to Guide for Developers<a class="headerlink" href="#how-to-guide-for-developers" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-guide-for-developers">How-to Guide for Developers</a></p>
<ul>
<li><p><a class="reference internal" href="#build-your-own-ops-quickly">1. Build Your Own OPs Quickly</a></p></li>
<li><p><a class="reference internal" href="#build-your-own-data-recipes-and-configs">2. Build Your Own Data Recipes and Configs</a></p>
<ul>
<li><p><a class="reference internal" href="#fruitful-config-sources-type-hints">2.1 Fruitful Config Sources &amp; Type Hints</a></p></li>
<li><p><a class="reference internal" href="#hierarchical-configs-and-helps">2.2 Hierarchical Configs and Helps</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#dependency-management">3. Dependency Management</a></p>
<ul>
<li><p><a class="reference internal" href="#installing-uv">3.1 Installing uv</a></p></li>
<li><p><a class="reference internal" href="#virtual-environment-management">3.2 Virtual Environment Management</a></p></li>
<li><p><a class="reference internal" href="#adding-new-dependencies">3.3 Adding New Dependencies</a></p></li>
<li><p><a class="reference internal" href="#development-setup">3.4 Development Setup</a></p></li>
<li><p><a class="reference internal" href="#lazy-loading">3.5 Lazy Loading</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#contribution-to-the-open-source-community">4. Contribution to the Open-source Community</a></p>
<ul>
<li><p><a class="reference internal" href="#coding-style">4.1 Coding Style</a></p></li>
<li><p><a class="reference internal" href="#documentation-style">4.2 Documentation Style</a></p></li>
<li><p><a class="reference internal" href="#contribute-your-new-ops-to-the-open-source-community">4.3 Contribute Your New OPs to the Open-Source Community</a></p>
<ul>
<li><p><a class="reference internal" href="#providing-basic-op-functions-alpha-version">4.3.1 Providing Basic OP Functions (alpha version)</a></p></li>
<li><p><a class="reference internal" href="#making-the-op-more-usable-beta-version">4.3.2 Making the OP More Usable (beta version)</a></p></li>
<li><p><a class="reference internal" href="#making-op-faster-more-complete-stable-version">4.3.3 Making OP Faster &amp; More complete (stable version)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#contribute-your-new-recipes">4.4 Contribute Your New Recipes</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<section id="build-your-own-ops-quickly">
<h2>1. Build Your Own OPs Quickly<a class="headerlink" href="#build-your-own-ops-quickly" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Data-Juicer allows everybody to easily build their own OPs.</p></li>
<li><p>Before implementing a new OP, please refer to existing <a class="reference internal" href="Operators.html"><span class="std std-doc">OperatorsZoo</span></a> to avoid unnecessary duplication.</p></li>
</ul>
<blockquote>
<div><p>The development process of the following example takes directly adding operators in the corresponding module of the source code as an example. If an operator is added externally, the new operator can be registered by passing the parameter <code class="docutils literal notranslate"><span class="pre">--custom-operator-paths</span></code> or configuring the <code class="docutils literal notranslate"><span class="pre">custom_operator_paths</span></code> parameter in the yaml file, for example: <code class="docutils literal notranslate"><span class="pre">custom_operator_paths:</span> <span class="pre">['/path/to/new/op.py',</span> <span class="pre">'/path/to/new/ops/directory/]</span></code>.</p>
</div></blockquote>
<p>Assuming we want to add a new Filter operator called ‚ÄúTextLengthFilter‚Äù to get corpus of expected text length, we can follow the following steps to build it.</p>
<ol class="arabic simple">
<li><p>(Optional) If the new OP defines  some statistical variables, please add the corresponding new <code class="docutils literal notranslate"><span class="pre">StatsKeysConstant</span></code> attribute in <code class="docutils literal notranslate"><span class="pre">data_juicer/utils/constant.py</span></code> for unified management.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">StatsKeysConstant</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>              <span class="c1"># other keys</span>
    <span class="n">text_len</span> <span class="o">=</span> <span class="s1">&#39;text_len&#39;</span>
</pre></div>
</div>
<ol class="arabic" start="2">
<li><p>Create a new OP file <code class="docutils literal notranslate"><span class="pre">text_length_filter.py</span></code> in the corresponding <code class="docutils literal notranslate"><span class="pre">data_juicer/ops/filter/</span></code> directory as follows.</p>
<ul class="simple">
<li><p>It‚Äôs a Filter OP, so the new OP needs to inherit from the basic <code class="docutils literal notranslate"><span class="pre">Filter</span></code> class in the <code class="docutils literal notranslate"><span class="pre">base_op.py</span></code>, and be decorated with <code class="docutils literal notranslate"><span class="pre">&#64;OPERATORS.register_module(xx_op)</span></code> to register itself automatically.</p></li>
<li><p>For convenience, we can implement the core functions <code class="docutils literal notranslate"><span class="pre">compute_stats_single</span></code> and <code class="docutils literal notranslate"><span class="pre">process_single</span></code> in a single-sample way, whose input and output are a single sample dictionary.</p></li>
<li><p>[Advanced] If you are familiar with batched processing in Data-Juicer, you can also implement the batched version directly by overwriting the <code class="docutils literal notranslate"><span class="pre">compute_stats_batched</span></code> and <code class="docutils literal notranslate"><span class="pre">process_batched</span></code> functions, which will be slightly faster than single-sample version. Their input and output are a column-wise dict with multiple samples (detailed in the following Section 4.3.3).</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">jsonargparse.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PositiveInt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.constant</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fields</span><span class="p">,</span> <span class="n">StatsKeys</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.ops.base_op</span><span class="w"> </span><span class="kn">import</span> <span class="n">OPERATORS</span><span class="p">,</span> <span class="n">Filter</span>


<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s1">&#39;text_length_filter&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TextLengthFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter to keep samples with total text length within a specific</span>
<span class="sd">    range.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">min_len</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">max_len</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialization method.</span>

<span class="sd">        :param min_len: The min text length in the filtering. samples</span>
<span class="sd">            will be filtered if their text length is below this</span>
<span class="sd">            parameter.</span>
<span class="sd">        :param max_len: The max text length in the filtering. samples</span>
<span class="sd">            will be filtered if their text length exceeds this</span>
<span class="sd">            parameter.</span>
<span class="sd">        :param args: extra args</span>
<span class="sd">        :param kwargs: extra args</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_len</span> <span class="o">=</span> <span class="n">min_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_stats_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="c1"># check if it&#39;s computed already</span>
        <span class="k">if</span> <span class="n">StatsKeys</span><span class="o">.</span><span class="n">text_len</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">stats</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">sample</span>

        <span class="c1"># compute text length and store it in the corresponding stats field</span>
        <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">stats</span><span class="p">][</span><span class="n">StatsKeys</span><span class="o">.</span><span class="n">text_len</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_key</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_len</span> <span class="o">&lt;=</span> <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">stats</span><span class="p">][</span><span class="n">StatsKeys</span><span class="o">.</span><span class="n">text_len</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</li>
<li><p>After implementation, add it to the OP dictionary in the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in <code class="docutils literal notranslate"><span class="pre">data_juicer/ops/filter/</span></code> directory.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># other OPs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.text_length_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextLengthFilter</span>  <span class="c1"># import this new OP class</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># other Ops</span>
    <span class="s2">&quot;TextLengthFilter&quot;</span><span class="p">,</span>  <span class="c1"># add this new Op to __all__</span>
<span class="p">]</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>When an operator has package dependencies listed in <code class="docutils literal notranslate"><span class="pre">environments/science_requires.txt</span></code>, you need to add the corresponding dependency packages to the <code class="docutils literal notranslate"><span class="pre">OPS_TO_PKG</span></code> dictionary in <code class="docutils literal notranslate"><span class="pre">data_juicer/utils/auto_install_mapping.py</span></code> to support dependency installation at the operator level.</p></li>
<li><p>Now you can use this new OP with custom arguments in your own config files!</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># other configs</span>
<span class="nn">...</span>

<span class="c1"># process configs</span>
<span class="nt">process</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">text_length_filter</span><span class="p">:</span><span class="w">  </span><span class="c1"># add this OP to your process list and set the parameters</span>
<span class="w">      </span><span class="nt">min_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">      </span><span class="nt">max_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p>Community contributors can submit corresponding operator PRs and work with the Data-Juicer team to gradually improve it in subsequent PRs. Please see more details <a class="reference internal" href="#contribution-to-the-open-source-community">below</a>. We greatly welcome co-construction and will <a class="reference external" href="https://github.com/datajuicer/data-juicer?tab=readme-ov-file#contribution-and-acknowledgements">highlight acknowledgements</a>!</p></li>
</ol>
</section>
<section id="build-your-own-data-recipes-and-configs">
<h2>2. Build Your Own Data Recipes and Configs<a class="headerlink" href="#build-your-own-data-recipes-and-configs" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We provide easy configuration based on <a class="reference external" href="https://github.com/omni-us/jsonargparse/">jsonargparse</a> to reduce cost for boilerplate codes.</p></li>
<li><p>We provide fruitful examples in <a class="reference external" href="https://datajuicer.github.io/data-juicer-hub/en/main/docs/RecipeGallery.html">Data Recipe Gallery</a> for reference reuse and extension.</p></li>
<li><p>üì£üì£üì£ Community contributors can submit PRs in the <em>Data Recipe Gallery</em> to add customized data recipes to promote dissemination, reuse and related technical evolution. We greatly welcome co-construction and will highlight <a class="reference external" href="https://github.com/datajuicer/data-juicer?tab=readme-ov-file#contribution-and-acknowledgements">acknowledgements</a>!</p></li>
</ul>
<section id="fruitful-config-sources-type-hints">
<h3>2.1 Fruitful Config Sources &amp; Type Hints<a class="headerlink" href="#fruitful-config-sources-type-hints" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>A global config object can be initialized via</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># core.executor.py</span>
<span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">init_configs</span><span class="p">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>in which function arguments from diverse sources can be specified and mixed
up, including</p></li>
</ul>
<ol class="arabic simple">
<li><p><em>hard-coded default values</em> when registering the config into parser or specified in the classes‚Äô <code class="docutils literal notranslate"><span class="pre">__init__</span></code> functions</p></li>
<li><p>default <em>config files</em> in json (yaml or jsonnet supersets)</p></li>
<li><p><em>environment variables</em></p></li>
<li><p><em>POSIX-style command line arguments</em>, such as <code class="docutils literal notranslate"><span class="pre">--project_name</span> <span class="pre">my_data_demo</span></code> or <code class="docutils literal notranslate"><span class="pre">--project_name=my_data_demo</span></code> , including config files</p></li>
</ol>
<ul class="simple">
<li><p>The final parsed values are mixed from these sources. And the override order is the same as the numbers above.</p></li>
</ul>
<p>Besides, many argument types and respective validation are supported.
Including python built-in types, types from <a class="reference external" href="https://docs.python.org/3/library/typing.html">Lib/typing</a> module, and
extended <a class="reference external" href="https://jsonargparse.readthedocs.io/en/stable/#type-hints">types</a>
from jsonargparse, such as <code class="docutils literal notranslate"><span class="pre">restricted</span> <span class="pre">types</span></code> and <code class="docutils literal notranslate"><span class="pre">Paths</span></code> with customized
limitations.</p>
</section>
<section id="hierarchical-configs-and-helps">
<h3>2.2 Hierarchical Configs and Helps<a class="headerlink" href="#hierarchical-configs-and-helps" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>You can use dot notation in the argument names freely to define the
hierarchy, e.g., <code class="docutils literal notranslate"><span class="pre">maximum_line_length_filter.min</span></code>.
More importantly, by default, we automatically register the configs from
the docstrings of implemented operators. That is, the structure of all
configs are always in sync with codes.</p></li>
<li><p>You can get the hierarchical help information by running a script that calls
our executor such as</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python tools/process_data.py --help

usage: process_data.py [-h] [--config CONFIG] [--print_config[=flags]] [--project_name PROJECT_NAME] [--dataset_path DATASET_PATH] [--dataset_dir DATASET_DIR] [--export_path EXPORT_PATH] [--process PROCESS]
                            [--np NP] [--text_keys TEXT_KEYS] [--document_deduplicator CONFIG] [--document_deduplicator.hash_method HASH_METHOD] [--document_deduplicator.lowercase LOWERCASE]
                            [--document_deduplicator.ignore_non_character IGNORE_NON_CHARACTER] [--language_id_score_filter CONFIG] [--language_id_score_filter.lang LANG] [--words_num_filter CONFIG] [--words_num_filter.min MIN] [--words_num_filter.max MAX]
                            [--alphanumeric_filter CONFIG] [--alphanumeric_filter.min MIN] [--alphanumeric_filter.max MAX] [--average_line_length_filter CONFIG] [--average_line_length_filter.min MIN] [--average_line_length_filter.max MAX]
                            [--maximum_line_length_filter CONFIG] [--maximum_line_length_filter.min MIN] [--maximum_line_length_filter.max MAX] [--text_length_filter CONFIG] [--text_length_filter.min MIN] [--text_length_filter.max MAX]
                            [--remove_comments_mapper CONFIG] [--remove_comments_mapper.type TYPE] [--remove_comments_mapper.inline INLINE] [--remove_comments_mapper.multiline MULTILINE] [--remove_header_mapper CONFIG]
                            [--remove_header_mapper.before_section BEFORE_SECTION]

optional arguments:
  -h, --help            Show this help message and exit.
  --config CONFIG       Path to a configuration file.
  --print_config[=flags]
                        Print the configuration after applying all other arguments and exit. The optional flags customizes the output and are one or more keywords separated by comma. The supported flags are: comments, skip_default, skip_null.
  --project_name PROJECT_NAME
                        name of your data process project. (type: str, default: null)
  --dataset_path DATASET_PATH
                        path to your dataset file, relative with respect to the config file&#39;s location (type: Path_fr, default: null)
  --dataset_dir DATASET_DIR
                        path to your dataset(s) within a directory, relative with respect to the config file&#39;s location (type: Path_drw, default: null)
  --export_path EXPORT_PATH
                        path to the output processed dataset, relative with respect to the config file&#39;s location (type: Path_fc, default: null)
  --process PROCESS, --process+ PROCESS
                        a list of several process operators with their arguments (type: List[Dict], default: null)
  --np NP               number of subprocess to process your dataset. (type: PositiveInt, default: null)

&lt;class &#39;data_juicer.ops.filter.alphanumeric_filter.AlphanumericFilter&#39;&gt;:
  --alphanumeric_filter CONFIG
                        Path to a configuration file.
  --alphanumeric_filter.min MIN
                        the min filter rate in alphanumeric op. (type: ClosedUnitInterval, default: 0.0)
  --alphanumeric_filter.max MAX
                        the max filter rate in alphanumeric op. (type: ClosedUnitInterval, default: 0.25)

&lt;class &#39;data_juicer.ops.filter.text_length_filter.TextLengthFilter&#39;&gt;:
  --text_length_filter CONFIG
                        Path to a configuration file.
  --text_length_filter.min MIN
                        min text length in the filtering (type: int, default: 10)
  --text_length_filter.max MAX
                        max text length in the filtering (type: int, default: 10000)

......

</pre></div>
</div>
</section>
</section>
<section id="dependency-management">
<h2>3. Dependency Management<a class="headerlink" href="#dependency-management" title="Link to this heading">#</a></h2>
<p>Data-Juicer uses a modern dependency management system based on <code class="docutils literal notranslate"><span class="pre">uv</span></code> and <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>. Dependencies are managed through the standard Python packaging format (PEP 621) and installed on-demand using a lazy loading system.</p>
<section id="installing-uv">
<h3>3.1 Installing uv<a class="headerlink" href="#installing-uv" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">uv</span></code> is a fast Python package installer and resolver, as a better drop-in replacement for pip. You can install it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using curl</span>
curl<span class="w"> </span>-LsSf<span class="w"> </span>https://astral.sh/uv/install.sh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh

<span class="c1"># Or using pip</span>
pip<span class="w"> </span>install<span class="w"> </span>uv
</pre></div>
</div>
<p>After installation, verify it‚Äôs working by running <code class="docutils literal notranslate"><span class="pre">uv</span> <span class="pre">--version</span></code>.</p>
</section>
<section id="virtual-environment-management">
<h3>3.2 Virtual Environment Management<a class="headerlink" href="#virtual-environment-management" title="Link to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">uv</span></code> provides virtual environment management capabilities that replaces <code class="docutils literal notranslate"><span class="pre">venv</span></code> and <code class="docutils literal notranslate"><span class="pre">virtualenv</span></code>. Here are the common commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new virtual environment</span>
uv<span class="w"> </span>venv

<span class="c1"># Or create a virtual environment with a specific Python version</span>
uv<span class="w"> </span>venv<span class="w"> </span>--python<span class="w"> </span><span class="m">3</span>.10

<span class="c1"># Activate the virtual environment</span>
<span class="c1"># On Unix/macOS</span>
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate
<span class="c1"># On Windows</span>
.venv<span class="se">\S</span>cripts<span class="se">\a</span>ctivate

<span class="c1"># Install minimal dependencies in the virtual environment</span>
uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.
</pre></div>
</div>
</section>
<section id="adding-new-dependencies">
<h3>3.3 Adding New Dependencies<a class="headerlink" href="#adding-new-dependencies" title="Link to this heading">#</a></h3>
<p>To add new dependencies:</p>
<ol class="arabic simple">
<li><p>Add them to the appropriate section in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>:</p>
<ul class="simple">
<li><p>Core dependencies go in <code class="docutils literal notranslate"><span class="pre">[project.dependencies]</span></code></p></li>
<li><p>Optional dependencies go in <code class="docutils literal notranslate"><span class="pre">[project.optional-dependencies]</span></code> under the appropriate group (generic, dev, audio, video, etc.)</p></li>
</ul>
</li>
<li><p>The lazy loading system will automatically handle installation when the dependencies are first used.</p></li>
</ol>
<p>Example:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[project.dependencies]</span>
<span class="c1"># Core dependencies</span>
<span class="n">numpy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&gt;=1.26.4,&lt;2.0.0&quot;</span>

<span class="k">[project.optional-dependencies]</span>
<span class="n">generic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;torch==2.6.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;transformers&gt;=4.47.0&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="err">...</span>
<span class="err">]</span>
</pre></div>
</div>
</section>
<section id="development-setup">
<h3>3.4 Development Setup<a class="headerlink" href="#development-setup" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Install the package with all dependencies:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[all]&quot;</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Or install with specific groups:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[generic]&quot;</span><span class="w">      </span><span class="c1"># Generic dependencies</span>
uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[dev]&quot;</span><span class="w">          </span><span class="c1"># Development tools</span>
uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[ai_services]&quot;</span><span class="w">  </span><span class="c1"># Services dependencies</span>
</pre></div>
</div>
</section>
<section id="lazy-loading">
<h3>3.5 Lazy Loading<a class="headerlink" href="#lazy-loading" title="Link to this heading">#</a></h3>
<p>The lazy loading system automatically installs dependencies when they are first used. This means:</p>
<ul class="simple">
<li><p>Initial installation is faster</p></li>
<li><p>Only required dependencies are installed</p></li>
<li><p>Dependencies are installed on-demand</p></li>
<li><p>Uses <code class="docutils literal notranslate"><span class="pre">uv</span></code> for fast installation when available</p></li>
</ul>
</section>
</section>
<section id="contribution-to-the-open-source-community">
<h2>4. Contribution to the Open-source Community<a class="headerlink" href="#contribution-to-the-open-source-community" title="Link to this heading">#</a></h2>
<section id="coding-style">
<h3>4.1 Coding Style<a class="headerlink" href="#coding-style" title="Link to this heading">#</a></h3>
<p>We define our styles in <code class="docutils literal notranslate"><span class="pre">.pre-commit-config.yaml</span></code>. Before committing,
please install <code class="docutils literal notranslate"><span class="pre">pre-commit</span></code> tool to automatically check and modify accordingly:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===========install pre-commit tool===========</span>
uv<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pre-commit

<span class="nb">cd</span><span class="w"> </span>&lt;path_to_data_juicer&gt;
<span class="c1"># install pre-commit script for data_juicer</span>
pre-commit<span class="w"> </span>install


<span class="c1"># ===========check all files===========</span>
git<span class="w"> </span>add<span class="w"> </span>.
pre-commit<span class="w"> </span>run<span class="w"> </span>--all-files

<span class="c1"># commit after all checking are passed</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;xxxx&quot;</span>
</pre></div>
</div>
<p><strong>Note</strong>: We have configured pre-commit checks in github workflow. If this
check in your PR fails, please locally ‚ë† ensure that the relevant
dependencies of pre-commit are consistent with the project configuration
(which can be completed through <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">clean</span></code> and <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">install</span></code>);
and ‚ë° execute <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">run</span> <span class="pre">--all-files</span></code> before push.</p>
</section>
<section id="documentation-style">
<h3>4.2 Documentation Style<a class="headerlink" href="#documentation-style" title="Link to this heading">#</a></h3>
<p>We use Sphinx for document management. To ensure the smooth integration of development documents into the Sphinx documentation system, please pay attention to the following guidelines when writing:</p>
<ol class="arabic simple">
<li><p>Heading Hierarchy</p>
<ul class="simple">
<li><p>Level 1 Heading (<code class="docutils literal notranslate"><span class="pre">#</span></code>): Each document <strong>must and can only</strong> contain one Level 1 heading, which serves as the overall title of the document.</p></li>
<li><p>Ensure the heading hierarchy is correct and avoid skipping heading levels. For example, a Level 1 heading should be followed by a Level 2 heading, not a Level 3 heading.</p></li>
</ul>
</li>
<li><p>File Naming Conventions</p>
<ul class="simple">
<li><p>Chinese Documents: Chinese Markdown files must be named with the suffix <code class="docutils literal notranslate"><span class="pre">_ZH</span></code>. For example: <code class="docutils literal notranslate"><span class="pre">README_ZH.md</span></code></p></li>
</ul>
</li>
</ol>
</section>
<section id="contribute-your-new-ops-to-the-open-source-community">
<h3>4.3 Contribute Your New OPs to the Open-Source Community<a class="headerlink" href="#contribute-your-new-ops-to-the-open-source-community" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>To faciliate community contribution, according to the implementation progress, OP will be categorized into 3 types of versions:</p>
<ul>
<li><p><img alt="alpha" src="https://img.shields.io/badge/alpha-red?style=plastic" /> version: Only the basic OP implementations are finished.</p></li>
<li><p><img alt="beta" src="https://img.shields.io/badge/beta-yellow?style=plastic" /> version: Based on the alpha version, unittests for this OP and basic docstring are added as well.</p></li>
<li><p><img alt="stable" src="https://img.shields.io/badge/stable-green?style=plastic" /> version: Based on the beta version, OP optimizations (e.g. model management, batched processing, OP fusion, ‚Ä¶)</p></li>
</ul>
</li>
<li><p>Community contributors can submit corresponding operator PRs in the alpha state. After that, the contributor can work with the Data-Juicer team to gradually improve it to beta and stable versions in subsequent PRs. We welcome co-construction and will highlight <a class="reference external" href="https://github.com/datajuicer/data-juicer?tab=readme-ov-file#contribution-and-acknowledgements">acknowledgements</a>!</p></li>
<li><p>Welcome to add the corresponding references of your new recipe (e.g., a new implementation inspired by some existing ideas or codes, or an advanced algorithm proposed in an existing paper).</p></li>
</ul>
<section id="providing-basic-op-functions-alpha-version">
<h4>4.3.1 Providing Basic OP Functions (alpha version)<a class="headerlink" href="#providing-basic-op-functions-alpha-version" title="Link to this heading">#</a></h4>
<p>In the previous <a class="reference internal" href="#build-your-own-ops-quickly">section</a>, the operator we implemented has already fulfilled the basic functionalities, thus meeting the requirements for the <img alt="alpha" src="https://img.shields.io/badge/alpha-red?style=plastic" /> version. Next, we will introduce how to extend this operator to make it more usable and standardized.</p>
</section>
<section id="making-the-op-more-usable-beta-version">
<h4>4.3.2 Making the OP More Usable (beta version)<a class="headerlink" href="#making-the-op-more-usable-beta-version" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>(<img alt="beta" src="https://img.shields.io/badge/beta-yellow?style=plastic" /> strongly recommended) In order to enhance the robustness of the code, verify the correctness and intuitively show how to use its functions, it is best to unit test the newly added operators. For the <code class="docutils literal notranslate"><span class="pre">TextLengthFilter</span></code> operator above, implement a test file such as <code class="docutils literal notranslate"><span class="pre">test_text_length_filter.py</span></code> in <code class="docutils literal notranslate"><span class="pre">tests/ops/filter/</span></code>:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.ops.filter.text_length_filter</span><span class="w"> </span><span class="kn">import</span> <span class="n">TextLengthFilter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.unittest_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataJuicerTestCaseBase</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TextLengthFilterTest</span><span class="p">(</span><span class="n">DataJuicerTestCaseBase</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_func1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_func2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_func3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<ul>
<li><p>(<img alt="beta" src="https://img.shields.io/badge/beta-yellow?style=plastic" /> strongly recommend) In order to facilitate other users to understand and use, it is best to update the newly added operator information to the corresponding documents, including the following two basic actions:</p>
<ol class="arabic simple">
<li><p>Please add basic information to the doc string of the operator class to ensure that it is complete and readable (including basic function description of the operator, input parameters, output parameters, etc.). There is no need for users to write in multiple places. Our <code class="docutils literal notranslate"><span class="pre">pre-commit</span></code> and sphinx build scripts will automatically extract doc strings to form operator pool documents and API documents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data_juicer/config/config_all.yaml</span></code>: This complete configuration file saves a list of all operators and parameters, as a source of information for some automated features and one of the important documents for users to refer to available operators. Therefore, after adding a new operator, please also add it to the document process list (grouped by operator type and sorted alphabetically):</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">...</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">stopwords_filter</span><span class="p">:</span><span class="w">                                       </span><span class="c1"># filter text with stopword ratio smaller than a specific min value</span>
<span class="w">    </span><span class="nt">lang</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">en</span><span class="w">                                                </span><span class="c1"># consider stopwords in what language</span>
<span class="w">    </span><span class="nt">tokenization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">                                     </span><span class="c1"># whether to use model to tokenize documents</span>
<span class="w">    </span><span class="nt">min_ratio</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3</span><span class="w">                                          </span><span class="c1"># the min ratio to filter text</span>
<span class="w">    </span><span class="nt">stopwords_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./assets</span><span class="w">                                 </span><span class="c1"># directory to store stopwords dictionaries</span>
<span class="w">    </span><span class="nt">use_words_aug</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">                                    </span><span class="c1"># whether to augment words, especially for Chinese and Vietnamese</span>
<span class="w">    </span><span class="nt">words_aug_group_sizes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">]</span><span class="w">                              </span><span class="c1"># the group size of words to augment</span>
<span class="w">    </span><span class="nt">words_aug_join_char</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w">                                 </span><span class="c1"># the join char between words to augment</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">text_length_filter</span><span class="p">:</span><span class="w">                                     </span><span class="c1"># filter text with length out of specific range</span>
<span class="w">    </span><span class="nt">min_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                                             </span><span class="c1"># the min length of filter range</span>
<span class="w">    </span><span class="nt">max_len</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span><span class="w">                                          </span><span class="c1"># the max length of filter range</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">token_num_filter</span><span class="p">:</span><span class="w">                                       </span><span class="c1"># filter text with total token number out of specific range</span>
<span class="w">    </span><span class="nt">hf_tokenizer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EleutherAI/pythia-6.9b-deduped</span><span class="w">            </span><span class="c1"># name of used Hugging Face tokenizer</span>
<span class="w">    </span><span class="nt">min_num</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">                                             </span><span class="c1"># the min number of filter range</span>
<span class="w">    </span><span class="nt">max_num</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span><span class="w">                                          </span><span class="c1"># the max number of filter range</span>
<span class="nn">...</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="making-op-faster-more-complete-stable-version">
<h4>4.3.3 Making OP Faster &amp; More complete (stable version)<a class="headerlink" href="#making-op-faster-more-complete-stable-version" title="Link to this heading">#</a></h4>
<ul>
<li><p>(<img alt="stable" src="https://img.shields.io/badge/stable-green?style=plastic" />) If Hugging Face models are used within an operator, you might want to leverage GPU acceleration. To achieve this, declare <code class="docutils literal notranslate"><span class="pre">_accelerator</span> <span class="pre">=</span> <span class="pre">'cuda'</span></code> in the OP‚Äôs constructor, and ensure that <code class="docutils literal notranslate"><span class="pre">compute_stats_single/batched</span></code> and <code class="docutils literal notranslate"><span class="pre">process_single/batched</span></code> methods accept an additional positional argument <code class="docutils literal notranslate"><span class="pre">rank</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... (same as above)</span>

<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="s1">&#39;text_length_filter&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TextLengthFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>

    <span class="n">_accelerator</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">min_len</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">max_len</span><span class="p">:</span> <span class="n">PositiveInt</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># ... (same as above)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_stats_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># ... (same as above)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># ... (same as above)</span>
</pre></div>
</div>
</li>
<li><p>(<img alt="stable" src="https://img.shields.io/badge/stable-green?style=plastic" />) If the operator processes data in batches rather than a single sample, or you want to enable batched processing, it is necessary to declare <code class="docutils literal notranslate"><span class="pre">_batched_op</span> <span class="pre">=</span> <span class="pre">True</span></code>.
- For the original <code class="docutils literal notranslate"><span class="pre">compute_stats_single</span></code> and <code class="docutils literal notranslate"><span class="pre">process_single</span></code> functions, you can keep it still and Data-Juicer will call the default batched version to call the single version to support batched processing. Or you can implement your batched version in a more efficient way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... (import some other libraries)</span>
<span class="n">OP_NAME</span> <span class="o">=</span> <span class="s1">&#39;image_diffusion_mapper&#39;</span>
<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="nd">@LOADED_IMAGES</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageDiffusionMapper</span><span class="p">(</span><span class="n">Mapper</span><span class="p">):</span>
    <span class="n">_batched_op</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="c1"># ... (OP parameters)</span>
             <span class="o">*</span><span class="n">args</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_batched</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="c1"># ... (some codes)</span>
</pre></div>
</div>
</li>
<li><p>(<img alt="stable" src="https://img.shields.io/badge/stable-green?style=plastic" />) In a mapper operator, to avoid process conflicts and data coverage, we offer an interface to make a saving path for produced extra data. The format of the saving path is <code class="docutils literal notranslate"><span class="pre">{ORIGINAL_DATAPATH}/__dj__produced_data__/{OP_NAME}/{ORIGINAL_FILENAME}__dj_hash_#{HASH_VALUE}#.{EXT}</span></code>, where the <code class="docutils literal notranslate"><span class="pre">HASH_VALUE</span></code> is hashed from the init parameters of the operator, the related parameters in each sample, the process ID, and the timestamp. You can also specify the save path (for example, save_dir) or set the storage path through the environment variable <code class="docutils literal notranslate"><span class="pre">DJ_PRODUCED_DATA_DIR</span></code>. For convenience, we can call <code class="docutils literal notranslate"><span class="pre">self.remove_extra_parameters(locals())</span></code> at the beginning of the initiation to get the init parameters. At the same time, we can call <code class="docutils literal notranslate"><span class="pre">self.add_parameters</span></code> to add related parameters with the produced extra data from each sample. Take the operator which enhances the images with diffusion models as example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.file_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">transfer_filename</span>
<span class="c1"># ... (import some other libraries)</span>
<span class="n">OP_NAME</span> <span class="o">=</span> <span class="s1">&#39;image_diffusion_mapper&#39;</span>
<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="nd">@LOADED_IMAGES</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ImageDiffusionMapper</span><span class="p">(</span><span class="n">Mapper</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="c1"># ... (OP parameters)</span>
             <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="o">*</span><span class="n">args</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_extra_parameters</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="c1"># ... (some codes)</span>
        <span class="c1"># captions[index] is the prompt for diffusion model</span>
        <span class="n">related_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_parameters</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_init_parameters</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">captions</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">new_image_path</span> <span class="o">=</span> <span class="n">transfer_filename</span><span class="p">(</span>
                <span class="n">origin_image_path</span><span class="p">,</span> <span class="n">OP_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">related_parameters</span><span class="p">)</span>
        <span class="c1"># ... (some codes)</span>
</pre></div>
</div>
<p>For the mapper to produce multi extra data base on one origin data, we can add suffix at the saving path. Take the operator which splits videos according to their key frames as example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.file_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_suffix_to_filename</span><span class="p">,</span> <span class="n">transfer_filename</span>
<span class="c1"># ... (import some other libraries)</span>
<span class="n">OP_NAME</span> <span class="o">=</span> <span class="s1">&#39;video_split_by_key_frame_mapper&#39;</span>
<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="nd">@LOADED_VIDEOS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VideoSplitByKeyFrameMapper</span><span class="p">(</span><span class="n">Mapper</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="c1"># ... (OP parameters)</span>
             <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="o">*</span><span class="n">args</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_extra_parameters</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="c1"># ... (some codes)</span>
        <span class="n">split_video_path</span> <span class="o">=</span> <span class="n">transfer_filename</span><span class="p">(</span>
                    <span class="n">original_video_path</span><span class="p">,</span> <span class="n">OP_NAME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_init_parameters</span><span class="p">)</span>
        <span class="n">split_video_path</span> <span class="o">=</span> <span class="n">add_suffix_to_filename</span><span class="p">(</span><span class="n">split_video_path</span><span class="p">,</span>  <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># ... (some codes)</span>
</pre></div>
</div>
</li>
</ul>
<p>(<img alt="stable" src="https://img.shields.io/badge/stable-green?style=plastic" /> Optional) <strong>Make your OP fusible</strong></p>
<ul class="simple">
<li><p>If the calculation process of some intermediate variables in the new OP is reused in other existing OPs, this new OP can be
added to the fusible OPs to accelerate the whole data processing with OP fusion technology. (e.g. both the <code class="docutils literal notranslate"><span class="pre">words_num_filter</span></code>
and <code class="docutils literal notranslate"><span class="pre">word_repetition_filter</span></code> need to split the input text into words)</p></li>
<li><p>When opening OP fusion, these reused calculation processes and intermediate variables can be shared in the <code class="docutils literal notranslate"><span class="pre">context</span></code> between
OPs, thus reducing repeated calculations.</p></li>
<li><p>OPs that contain common intermediate variables can be fused in OP fusion through the following steps:</p></li>
</ul>
<ol class="arabic simple">
<li><p>(Optional) If a new intermediate variable is generated in the new OP, we need to add this new intermediate variable name to
the <code class="docutils literal notranslate"><span class="pre">InterVars</span></code> class in <code class="docutils literal notranslate"><span class="pre">utils/constant.py</span></code>. In general, we need to add a prefix <code class="docutils literal notranslate"><span class="pre">DEFAULT_PREFIX</span></code> before the name.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InterVars</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># text</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">DEFAULT_PREFIX</span> <span class="o">+</span> <span class="s1">&#39;lines&#39;</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">DEFAULT_PREFIX</span> <span class="o">+</span> <span class="s1">&#39;words&#39;</span>  <span class="c1"># add the new intermediate variable here</span>
    <span class="o">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>(Optional) We need to define a registry group in <code class="docutils literal notranslate"><span class="pre">ops/op_fusion.py</span></code> for the new intermediate variable in the 1st step, and add
this registry group to the registry group list that stores all groups of intermediate variables. This facilitates the OP Fusion module
to track OPs involving these intermediate variables.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="c1"># Type of intermediate vars</span>
<span class="c1"># text</span>
<span class="n">INTER_LINES</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">InterVars</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
<span class="n">INTER_WORDS</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">InterVars</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>  <span class="c1"># define registry group for the new intermediate variable</span>

<span class="c1"># images</span>
<span class="n">LOADED_IMAGES</span> <span class="o">=</span> <span class="n">Registry</span><span class="p">(</span><span class="n">InterVars</span><span class="o">.</span><span class="n">loaded_images</span><span class="p">)</span>

<span class="c1"># all</span>
<span class="n">ALL_INTER_VARS</span> <span class="o">=</span> <span class="p">[</span><span class="n">INTER_LINES</span><span class="p">,</span> <span class="n">INTER_WORDS</span><span class="p">,</span> <span class="n">LOADED_IMAGES</span><span class="p">]</span>  <span class="c1"># and add it to the registry group list</span>
<span class="o">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Before the OP class definition that involves the intermediate variable, register this OP in the registry group corresponding
to this intermediate variable, indicating that the intermediate variable may be calculated and used in this OP.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="nd">@OPERATORS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>
<span class="nd">@INTER_WORDS</span><span class="o">.</span><span class="n">register_module</span><span class="p">(</span><span class="n">OP_NAME</span><span class="p">)</span>  <span class="c1"># register this new OP into the registry group</span>
<span class="k">class</span><span class="w"> </span><span class="nc">WordsNumFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="o">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>In the calculation process of this intermediate variable of the new OP, we can modify the calculation logic to:</p>
<ol class="arabic simple">
<li><p>If the argument <code class="docutils literal notranslate"><span class="pre">context</span></code> is True, it means the OP fusion is opening, so we get the value of this intermediate variable
from <code class="docutils literal notranslate"><span class="pre">context</span></code> first, which has been calculated by the previous OPs.</p></li>
<li><p>If this intermediate variable doesn‚Äôt exist in the <code class="docutils literal notranslate"><span class="pre">context</span></code>, it means it‚Äôs the first time to calculate this variable in this
OP, so we need to define a unique key and use it to store the intermediate variable in the <code class="docutils literal notranslate"><span class="pre">context</span></code> for subsequent OPs after
it‚Äôs calculated by this new OP.</p></li>
<li><p>If the argument <code class="docutils literal notranslate"><span class="pre">context</span></code> is False, just follow the normal calculation process.</p></li>
</ol>
</li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># before modification</span>
<span class="o">...</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_key</span><span class="p">)</span>
<span class="n">words</span> <span class="o">=</span> <span class="n">get_words_from_document</span><span class="p">(</span>
    <span class="n">sample</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_key</span><span class="p">],</span>
    <span class="n">token_func</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode_as_pieces</span> <span class="k">if</span> <span class="n">tokenizer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
<span class="o">...</span>        

<span class="c1"># after modification</span>
<span class="o">...</span>
<span class="n">words_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">InterVars</span><span class="o">.</span><span class="n">words</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_key</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">words_key</span> <span class="ow">in</span> <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">context</span><span class="p">]:</span>
    <span class="c1"># get the value of intermediate variable from context directly</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">context</span><span class="p">][</span><span class="n">words_key</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># normal calculation process</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_key</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">get_words_from_document</span><span class="p">(</span>
        <span class="n">sample</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">text_key</span><span class="p">],</span>
        <span class="n">token_func</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode_as_pieces</span> <span class="k">if</span> <span class="n">tokenizer</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
        <span class="c1"># After calculating the intermediate variable for the first time,</span>
        <span class="c1"># store it in the context for subsequent OPs.</span>
        <span class="n">sample</span><span class="p">[</span><span class="n">Fields</span><span class="o">.</span><span class="n">context</span><span class="p">][</span><span class="n">words_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">words</span>
<span class="o">...</span>
</pre></div>
</div>
<ol class="arabic simple" start="5">
<li><p>As the number of OPs increases, Data-Juicer‚Äôs dependencies also multiply. To prevent Data-Juicer from becoming excessively burdened with dependencies, we‚Äôve implemented a strategy that incorporates lazy importing and on-demand installation of additional dependencies required by OPs. <code class="docutils literal notranslate"><span class="pre">LazyLoader</span></code> will check if the packages corresponding to the module being loaded are installed, and if not, it will dynamically install them automatically. Below is an example illustrating this approach:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... (import some library)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.lazy_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyLoader</span>

<span class="c1"># lazy import</span>
<span class="n">kenlm</span> <span class="o">=</span> <span class="n">LazyLoader</span><span class="p">(</span><span class="s1">&#39;kenlm&#39;</span><span class="p">)</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">LazyLoader</span><span class="p">(</span><span class="s1">&#39;sentencepiece&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PerplexityFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="c1"># ... (OP parameters)</span>
                <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># auto install before init</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">LazyLoader</span><span class="o">.</span><span class="n">check_packages</span><span class="p">([</span><span class="s1">&#39;fasttext-wheel&#39;</span><span class="p">])</span>
        <span class="c1"># ... (some codes)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_single</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">):</span>
        <span class="c1"># ... (some codes)</span>
</pre></div>
</div>
</section>
</section>
<section id="contribute-your-new-recipes">
<h3>4.4 Contribute Your New Recipes<a class="headerlink" href="#contribute-your-new-recipes" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Community contributors can submit PRs in the <a class="reference external" href="https://github.com/datajuicer/data-juicer-hub">Data Recipe Gallery</a> to add customized data recipes to promote dissemination, reuse and related technical evolution.</p></li>
<li><p>Feel free to add the corresponding references of your new recipe, or just propose some requirements/ideas to improve the existing recipes.</p></li>
<li><p>We greatly welcome co-construction and will highlight <a class="reference external" href="https://github.com/datajuicer/data-juicer?tab=readme-ov-file#contribution-and-acknowledgements">acknowledgements</a>!</p></li>
</ul>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="DJ_service.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">DJ_service</p>
      </div>
    </a>
    <a class="right-next"
       href="Distributed.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Distributed Data Processing in Data-Juicer</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-your-own-ops-quickly">1. Build Your Own OPs Quickly</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#build-your-own-data-recipes-and-configs">2. Build Your Own Data Recipes and Configs</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fruitful-config-sources-type-hints">2.1 Fruitful Config Sources &amp; Type Hints</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hierarchical-configs-and-helps">2.2 Hierarchical Configs and Helps</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dependency-management">3. Dependency Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-uv">3.1 Installing uv</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#virtual-environment-management">3.2 Virtual Environment Management</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-new-dependencies">3.3 Adding New Dependencies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#development-setup">3.4 Development Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lazy-loading">3.5 Lazy Loading</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contribution-to-the-open-source-community">4. Contribution to the Open-source Community</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#coding-style">4.1 Coding Style</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#documentation-style">4.2 Documentation Style</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contribute-your-new-ops-to-the-open-source-community">4.3 Contribute Your New OPs to the Open-Source Community</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#providing-basic-op-functions-alpha-version">4.3.1 Providing Basic OP Functions (alpha version)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#making-the-op-more-usable-beta-version">4.3.2 Making the OP More Usable (beta version)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#making-op-faster-more-complete-stable-version">4.3.3 Making OP Faster &amp; More complete (stable version)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contribute-your-new-recipes">4.4 Contribute Your New Recipes</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/docs/DeveloperGuide.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      ¬© Copyright 2024, Data-Juicer Team.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4.
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>
# vggt_mapper

Input a video of a single scene, and use VGGT to extract information including Camera Pose, Depth Maps, Point Maps, and 3D Point Tracks.

- The operator processes a video and extracts frames based on the specified frame number and duration.
- It uses the VGGT model to analyze the extracted frames and generate various outputs such as camera parameters, depth maps, point maps, and 3D point tracks.
- If 3D point tracks are required, the user must provide query points in the format [x, y], relative to the top-left corner.
- The results are stored in the sample's metadata under the specified tag field name, which defaults to 'vggt_tags'.
- The operator can output camera parameters, depth maps, point maps from projection, point maps from unprojection, and 3D point tracks, depending on the configuration.
- The VGGT model is loaded from the provided path, and the operator runs in CUDA mode if available.

è¾“å…¥å•ä¸ªåœºæ™¯çš„è§†é¢‘ï¼Œå¹¶ä½¿ç”¨VGGTæå–ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç›¸æœºå§¿æ€ã€æ·±åº¦å›¾ã€ç‚¹å›¾å’Œ3Dç‚¹è½¨è¿¹ã€‚

- è¯¥ç®—å­å¤„ç†è§†é¢‘å¹¶æ ¹æ®æŒ‡å®šçš„å¸§æ•°å’ŒæŒç»­æ—¶é—´æå–å¸§ã€‚
- å®ƒä½¿ç”¨VGGTæ¨¡å‹åˆ†ææå–çš„å¸§å¹¶ç”Ÿæˆå„ç§è¾“å‡ºï¼Œå¦‚ç›¸æœºå‚æ•°ã€æ·±åº¦å›¾ã€ç‚¹å›¾å’Œ3Dç‚¹è½¨è¿¹ã€‚
- å¦‚æœéœ€è¦3Dç‚¹è½¨è¿¹ï¼Œç”¨æˆ·å¿…é¡»æä¾›æŸ¥è¯¢ç‚¹ï¼Œæ ¼å¼ä¸º[x, y]ï¼Œç›¸å¯¹äºå·¦ä¸Šè§’ã€‚
- ç»“æœå­˜å‚¨åœ¨æ ·æœ¬å…ƒæ•°æ®ä¸­æŒ‡å®šçš„æ ‡ç­¾å­—æ®µåä¸‹ï¼Œé»˜è®¤ä¸º'vggt_tags'ã€‚
- æ ¹æ®é…ç½®ï¼Œç®—å­å¯ä»¥è¾“å‡ºç›¸æœºå‚æ•°ã€æ·±åº¦å›¾ã€æŠ•å½±ç‚¹å›¾ã€åæŠ•å½±ç‚¹å›¾å’Œ3Dç‚¹è½¨è¿¹ã€‚
- VGGTæ¨¡å‹ä»æä¾›çš„è·¯å¾„åŠ è½½ï¼Œå¦‚æœå¯ç”¨ï¼Œç®—å­å°†åœ¨CUDAæ¨¡å¼ä¸‹è¿è¡Œã€‚

Type ç®—å­ç±»å‹: **mapper**

Tags æ ‡ç­¾: gpu, video

## ğŸ”§ Parameter Configuration å‚æ•°é…ç½®
| name å‚æ•°å | type ç±»å‹ | default é»˜è®¤å€¼ | desc è¯´æ˜ |
|--------|------|--------|------|
| `vggt_model_path` | <class 'str'> | `'facebook/VGGT-1B'` | The path to the VGGT model. |
| `frame_num` | typing.Annotated[int, Gt(gt=0)] | `3` | The number of frames to be extracted uniformly from the video. If it's 1, only the middle frame will be extracted. If it's 2, only the first and the last frames will be extracted. If it's larger than 2, in addition to the first and the last frames, other frames will be extracted uniformly within the video duration. If "duration" > 0, frame_num is the number of frames per segment. |
| `duration` | <class 'float'> | `0` | The duration of each segment in seconds. If 0, frames are extracted from the entire video. If duration > 0, the video is segmented into multiple segments based on duration, and frames are extracted from each segment. |
| `tag_field_name` | <class 'str'> | `'vggt_tags'` | The field name to store the tags. It's "vggt_tags" in default. |
| `frame_dir` | <class 'str'> | `DATA_JUICER_ASSETS_CACHE` | Output directory to save extracted frames. |
| `if_output_camera_parameters` | <class 'bool'> | `True` | Determines whether to output camera parameters. |
| `if_output_depth_maps` | <class 'bool'> | `True` | Determines whether to output depth maps. |
| `if_output_point_maps_from_projection` | <class 'bool'> | `True` | Determines whether to output point maps directly inferred by VGGT. |
| `if_output_point_maps_from_unprojection` | <class 'bool'> | `True` | Determines whether to output point maps constructed from depth maps and camera parameters. |
| `if_output_point_tracks` | <class 'bool'> | `True` | Determines whether to output point tracks. If point tracks are required, the user should provide a list where each element consists of 2D point coordinates (list shape: (N, 2)). The point coordinates should be specified in the format [x, y], relative to the top-left corner, where x/y values are non-normalized. |
| `args` |  | `''` | extra args |
| `kwargs` |  | `''` | extra args |

## ğŸ“Š Effect demonstration æ•ˆæœæ¼”ç¤º
### test
```python
VggtMapper(vggt_model_path='facebook/VGGT-1B', frame_num=2, duration=2, frame_dir=DATA_JUICER_ASSETS_CACHE, if_output_camera_parameters=True, if_output_depth_maps=True, if_output_point_maps_from_projection=True, if_output_point_maps_from_unprojection=True, if_output_point_tracks=True)
```

#### ğŸ“¥ input data è¾“å…¥æ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> 1 video</div><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video11.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video11.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>query_points</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[[320.0, 200.0], [500.72, 100.94]]</td></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> 1 video</div><div class="media-section" style="margin-bottom:8px;"><div class="media-label" style="font-size:0.85em; color:#666; margin-bottom:4px; font-weight:500;">video10.mp4:</div><div class="video-grid"><video src="../../../tests/ops/data/video10.mp4" controls width="320" style="margin:4px;"></video></div></div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>query_points</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[[50.72, 100.94]]</td></tr></table></div></div>

#### ğŸ“¤ output data è¾“å‡ºæ•°æ®
<div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 1:</strong> empty</div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>camera_parameters_extrinsic</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 3, 4]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>camera_parameters_intrinsic</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 3, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>depth_maps_depth_maps</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 294, 518, 1]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>depth_maps_depth_conf</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 294, 518]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_projection_point_map</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 294, 518, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_projection_point_conf</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 294, 518]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_unprojection_point_maps_from_unprojection</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[10, 294, 518, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_track_list</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 2, 2]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_vis_score</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 2]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_conf_score</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 10, 2]</td></tr></table></div></div><div class="sample-card" style="border:1px solid #ddd; padding:12px; margin:8px 0; border-radius:6px; background:#fafafa; box-shadow:0 1px 3px rgba(0,0,0,0.1);"><div class="sample-header" style="background:#f8f9fa; padding:4px 8px; margin-bottom:6px; border-radius:3px; font-size:0.9em; color:#666; border-left:3px solid #007acc;"><strong>Sample 2:</strong> empty</div><div class='meta' style='margin:6px 0;'><table class='meta-table' style='border-collapse:collapse; width:100%; border:1px solid #e3e3e3;'><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>camera_parameters_extrinsic</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 3, 4]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>camera_parameters_intrinsic</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 3, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>depth_maps_depth_maps</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 392, 518, 1]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>depth_maps_depth_conf</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 392, 518]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_projection_point_map</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 392, 518, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_projection_point_conf</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 392, 518]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_maps_from_unprojection_point_maps_from_unprojection</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[18, 392, 518, 3]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_track_list</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 1, 2]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_vis_score</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 1]</td></tr><tr><th colspan='2' style='text-align:left; vertical-align:top; padding:6px 8px; font-weight:600; border-bottom:1px solid #e3e3e3;'>point_tracks_conf_score</th></tr><tr><td colspan='2' style='text-align:left; vertical-align:top; padding:4px 8px; padding-left:22px; border-bottom:1px solid #e3e3e3;'>[1, 18, 1]</td></tr></table></div></div>

#### âœ¨ explanation è§£é‡Š
The VggtMapper operator processes video data to extract various 3D information such as camera parameters, depth maps, and point tracks. The input consists of video files and query points. The output includes detailed 3D information for each video, such as the shape of the camera parameters, depth maps, and point tracks. This example demonstrates the typical use case where the operator processes a single video with multiple query points and outputs the corresponding 3D information.
VggtMapperç®—å­å¤„ç†è§†é¢‘æ•°æ®ä»¥æå–å„ç§3Dä¿¡æ¯ï¼Œå¦‚ç›¸æœºå‚æ•°ã€æ·±åº¦å›¾å’Œç‚¹è½¨è¿¹ã€‚è¾“å…¥åŒ…æ‹¬è§†é¢‘æ–‡ä»¶å’ŒæŸ¥è¯¢ç‚¹ã€‚è¾“å‡ºåŒ…å«æ¯ä¸ªè§†é¢‘çš„è¯¦ç»†3Dä¿¡æ¯ï¼Œä¾‹å¦‚ç›¸æœºå‚æ•°ã€æ·±åº¦å›¾å’Œç‚¹è½¨è¿¹çš„å½¢çŠ¶ã€‚æ­¤ç¤ºä¾‹å±•ç¤ºäº†å…¸å‹çš„ä½¿ç”¨åœºæ™¯ï¼Œå…¶ä¸­ç®—å­å¤„ç†å¸¦æœ‰å¤šä¸ªæŸ¥è¯¢ç‚¹çš„å•ä¸ªè§†é¢‘ï¼Œå¹¶è¾“å‡ºç›¸åº”çš„3Dä¿¡æ¯ã€‚


## ğŸ”— related links ç›¸å…³é“¾æ¥
- [source code æºä»£ç ](../../../data_juicer/ops/mapper/vggt_mapper.py)
- [unit test å•å…ƒæµ‹è¯•](../../../tests/ops/mapper/test_vggt_mapper.py)
- [Return operator list è¿”å›ç®—å­åˆ—è¡¨](../../Operators.md)

<!DOCTYPE html>


<html lang="zh-CN" data-content_root="../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>data_juicer.ops.common.prompt2prompt_pipeline &#8212; Data Juicer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=34d13042" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../_static/documentation_options.js?v=91bfbbb6"></script>
    <script src="../../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../_static/translations.js?v=540d3cec"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/data_juicer/ops/common/prompt2prompt_pipeline';</script>
    <script src="../../../../_static/sidebar.js?v=3fc1065c"></script>
    <script src="../../../../_static/switcher-mobile.js?v=07875724"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="icon" href="../../../../_static/icon.png"/>
    <link rel="index" title="Á¥¢Âºï" href="../../../../genindex.html" />
    <link rel="search" title="ÊêúÁ¥¢" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="zh-CN"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Ë∑≥ËΩ¨Ëá≥‰∏ªË¶ÅÂÜÖÂÆπ</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>ÂõûÂà∞È°∂ÈÉ®</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search docs..."
         aria-label="Search docs..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="ÁâàÊú¨Ë≠¶Âëä"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="ÁΩëÈ°µÂØºËà™">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../index_ZH.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../_static/icon.png" class="logo__image only-light" alt=""/>
    <img src="../../../../_static/icon.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">Data Juicer</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../docs_index_ZH.html">
    ÊñáÊ°£
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/zh_CN/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/zh_CN/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/zh_CN/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="ÊêúÁ¥¢" aria-label="ÊêúÁ¥¢" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="‰∫ÆËâ≤"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="ÊöóËâ≤"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: zh-CN">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">zh-CN</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../../../../en/main/_modules/data_juicer/ops/common/prompt2prompt_pipeline.html"
             class="dropdown-item "
             role="menuitem"
             >
            English
          </a>
        
          
          
          <a href="../../../../../../zh_CN/main/_modules/data_juicer/ops/common/prompt2prompt_pipeline_ZH.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../../../../main/_modules/data_juicer/ops/common/prompt2prompt_pipeline.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="ÊêúÁ¥¢" aria-label="ÊêúÁ¥¢" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../docs_index_ZH.html">
    ÊñáÊ°£
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../api.html">
    API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-sandbox/zh_CN/main/">
    Sandbox
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-hub/zh_CN/main/">
    Hub
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://datajuicer.github.io/data-juicer-agents/zh_CN/main/">
    Agents
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/wgj45424/data-juicer" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="‰∫ÆËâ≤"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="ÊöóËâ≤"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><div class="navbar-switcher-container">
  
  <div class="navbar-dropdown language-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select language: zh-CN">
      <span class="switcher-icon" aria-hidden="true">üåê</span>
      <span class="switcher-text">zh-CN</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
          
          
          <a href="../../../../../../en/main/_modules/data_juicer/ops/common/prompt2prompt_pipeline.html"
             class="dropdown-item "
             role="menuitem"
             >
            English
          </a>
        
          
          
          <a href="../../../../../../zh_CN/main/_modules/data_juicer/ops/common/prompt2prompt_pipeline_ZH.html"
             class="dropdown-item active"
             role="menuitem"
             aria-current="true">
            ÁÆÄ‰Ωì‰∏≠Êñá
          </a>
        
      </div>
    </div>
  </div>
  

  
  <div class="navbar-dropdown version-dropdown">
    <button type="button" 
            class="navbar-dropdown-trigger" 
            aria-haspopup="true"
            aria-expanded="false"
            aria-label="Select version: main">
      <span class="switcher-icon" aria-hidden="true">üì¶</span>
      <span class="switcher-text">main</span>
      <i class="fa-solid fa-chevron-down dropdown-icon" aria-hidden="true"></i>
    </button>
    <div class="navbar-dropdown-panel" role="menu">
      <div class="dropdown-content">
        
        <a href="../../../../../main/_modules/data_juicer/ops/common/prompt2prompt_pipeline.html"
           class="dropdown-item active"
           role="menuitem"
           aria-current="true">
          main
        </a>
        
      </div>
    </div>
  </div>
  
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../index_ZH.html" class="nav-link" aria-label="ÂàùÂßãÈ°µÈù¢">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../index.html" class="nav-link">Ê®°Âùó‰ª£Á†Å</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">data_juicer.ops.common.prompt2prompt_pipeline</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>data_juicer.ops.common.prompt2prompt_pipeline Ê∫ê‰ª£Á†Å</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">data_juicer.utils.lazy_loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">LazyLoader</span>

<span class="n">diffusers</span> <span class="o">=</span> <span class="n">LazyLoader</span><span class="p">(</span><span class="s2">&quot;diffusers&quot;</span><span class="p">)</span>
<span class="n">torch</span> <span class="o">=</span> <span class="n">LazyLoader</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>


<span class="c1"># Copied from diffusers.pipelines.stable_diffusion.</span>
<span class="c1"># pipeline_stable_diffusion.rescale_noise_cfg</span>
<div class="viewcode-block" id="rescale_noise_cfg">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.rescale_noise_cfg">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rescale_noise_cfg</span><span class="p">(</span><span class="n">noise_cfg</span><span class="p">,</span> <span class="n">noise_pred_text</span><span class="p">,</span> <span class="n">guidance_rescale</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rescale `noise_cfg` according to `guidance_rescale`. Based on</span>
<span class="sd">    findings of [Common Diffusion Noise Schedules and</span>
<span class="sd">    Sample Steps are Flawed](https://arxiv.org/pdf/2305.08891.pdf).</span>
<span class="sd">     See Section 3.4</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">std_text</span> <span class="o">=</span> <span class="n">noise_pred_text</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_pred_text</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">std_cfg</span> <span class="o">=</span> <span class="n">noise_cfg</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_cfg</span><span class="o">.</span><span class="n">ndim</span><span class="p">)),</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># rescale the results from guidance (fixes overexposure)</span>
    <span class="n">noise_pred_rescaled</span> <span class="o">=</span> <span class="n">noise_cfg</span> <span class="o">*</span> <span class="p">(</span><span class="n">std_text</span> <span class="o">/</span> <span class="n">std_cfg</span><span class="p">)</span>
    <span class="c1"># mix with the original results from guidance by factor guidance_rescale</span>
    <span class="c1">#  to avoid &quot;plain looking&quot; images</span>
    <span class="n">noise_cfg</span> <span class="o">=</span> <span class="n">guidance_rescale</span> <span class="o">*</span> <span class="n">noise_pred_rescaled</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">guidance_rescale</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_cfg</span>
    <span class="k">return</span> <span class="n">noise_cfg</span></div>



<span class="c1"># Copied from https://github.com/RoyiRa/prompt-to-prompt-with-sdxl</span>
<div class="viewcode-block" id="Prompt2PromptPipeline">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.Prompt2PromptPipeline">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Prompt2PromptPipeline</span><span class="p">(</span><span class="n">diffusers</span><span class="o">.</span><span class="n">pipelines</span><span class="o">.</span><span class="n">stable_diffusion_xl</span><span class="o">.</span><span class="n">StableDiffusionXLPipeline</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">    Prompt-to-Prompt-Pipeline for text-to-image generation using</span>
<span class="sd">    Stable Diffusion. This model inherits from</span>
<span class="sd">    [`StableDiffusionPipeline`]. Check the superclass documentation</span>
<span class="sd">     for the generic methods the library implements for</span>
<span class="sd">    all the pipelines (such as downloading or saving, running on a</span>
<span class="sd">    particular device, etc.)</span>
<span class="sd">        vae ([`AutoencoderKL`]):</span>
<span class="sd">            Variational Auto-Encoder (VAE) Model to encode and decode</span>
<span class="sd">            images to and from latent representations.</span>
<span class="sd">        text_encoder ([`CLIPTextModel`]):</span>
<span class="sd">            Frozen text-encoder. Stable Diffusion uses the text portion of</span>
<span class="sd">            [CLIP](https://huggingface.co/docs/transformers/model_doc/</span>
<span class="sd">            clip#transformers.CLIPTextModel), specifically</span>
<span class="sd">            the [clip-vit-large-patch14](https://huggingface.co/openai/</span>
<span class="sd">            clip-vit-large-patch14) variant.</span>
<span class="sd">        tokenizer (`CLIPTokenizer`):</span>
<span class="sd">            Tokenizer of class</span>
<span class="sd">            [CLIPTokenizer](https://huggingface.co/docs/transformers/</span>
<span class="sd">            v4.21.0/en/model_doc/clip#transformers.CLIPTokenizer).</span>
<span class="sd">        unet ([`UNet2DConditionModel`]): Conditional U-Net architecture</span>
<span class="sd">         to denoise the encoded image latents. scheduler</span>
<span class="sd">        ([`SchedulerMixin`]):</span>
<span class="sd">            A scheduler to be used in combination with `unet` to denoise</span>
<span class="sd">             the encoded image latents. Can be one of</span>
<span class="sd">            [`DDIMScheduler`], [`LMSDiscreteScheduler`], or [`PNDMScheduler`].</span>
<span class="sd">        safety_checker ([`StableDiffusionSafetyChecker`]):</span>
<span class="sd">            Classification module that estimates whether generated</span>
<span class="sd">             images could be considered offensive or harmful.</span>
<span class="sd">            Please, refer to the [model card](https://huggingface.co/</span>
<span class="sd">            runwayml/stable-diffusion-v1-5) for details.</span>
<span class="sd">        feature_extractor ([`CLIPFeatureExtractor`]):</span>
<span class="sd">            Model that extracts features from generated images to be</span>
<span class="sd">             used as inputs for the `safety_checker`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_optional_components</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;safety_checker&quot;</span><span class="p">,</span> <span class="s2">&quot;feature_extractor&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="Prompt2PromptPipeline.check_inputs">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.Prompt2PromptPipeline.check_inputs">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_inputs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">,</span>
        <span class="n">prompt_2</span><span class="p">,</span>
        <span class="n">height</span><span class="p">,</span>
        <span class="n">width</span><span class="p">,</span>
        <span class="n">callback_steps</span><span class="p">,</span>
        <span class="n">negative_prompt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_prompt_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_prompt_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pooled_prompt_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_pooled_prompt_embeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">width</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`height` and `width` have to be divisible by </span><span class="se">\</span>
<span class="s2">                    8 but are </span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">callback_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">callback_steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callback_steps</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">callback_steps</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`callback_steps` has to be a positive integer </span><span class="se">\</span>
<span class="s2">                    but is </span><span class="si">{</span><span class="n">callback_steps</span><span class="si">}</span><span class="s2"> of type&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">callback_steps</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot forward both `prompt`: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2"> and </span><span class="se">\</span>
<span class="s2">                    `prompt_embeds`: </span><span class="si">{</span><span class="n">prompt_embeds</span><span class="si">}</span><span class="s2">. Please make sure to&quot;</span>
                <span class="s2">&quot; only forward one of the two.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prompt_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot forward both `prompt_2`: </span><span class="si">{</span><span class="n">prompt_2</span><span class="si">}</span><span class="s2"> and </span><span class="se">\</span>
<span class="s2">                    `prompt_embeds`: </span><span class="si">{</span><span class="n">prompt_embeds</span><span class="si">}</span><span class="s2">. Please make sure to&quot;</span>
                <span class="s2">&quot; only forward one of the two.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prompt_embeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Provide either `prompt` or `prompt_embeds`. </span><span class="se">\</span>
<span class="s2">                    Cannot leave both `prompt` and `prompt_embeds` undefined.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`prompt` has to be of type `str` or `list` </span><span class="se">\</span>
<span class="s2">                    but is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">prompt_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_2</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;`prompt_2` has to be of type `str` or `list` </span><span class="se">\</span>
<span class="s2">                    but is </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">prompt_2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">negative_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negative_prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot forward both `negative_prompt`: </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">negative_prompt</span><span class="si">}</span><span class="s2"> and `negative_prompt_embeds`:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">negative_prompt_embeds</span><span class="si">}</span><span class="s2">. Please make sure </span><span class="se">\</span>
<span class="s2">                    to only forward one of the two.&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">negative_prompt_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negative_prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cannot forward both `negative_prompt_2`: </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">negative_prompt_2</span><span class="si">}</span><span class="s2"> and `negative_prompt_embeds`:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">negative_prompt_embeds</span><span class="si">}</span><span class="s2">. Please make sure </span><span class="se">\</span>
<span class="s2">                    to only forward one of the two.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negative_prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prompt_embeds</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">negative_prompt_embeds</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`prompt_embeds` and `negative_prompt_embeds` </span><span class="se">\</span>
<span class="s2">                        must have the same shape when passed directly, but&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; got: `prompt_embeds` </span><span class="si">{</span><span class="n">prompt_embeds</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        != `negative_prompt_embeds`&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">negative_prompt_embeds</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pooled_prompt_embeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;If `prompt_embeds` are provided, `pooled_prompt_embeds` </span><span class="se">\</span>
<span class="s2">                    also have to be passed. Make sure to generate </span><span class="se">\</span>
<span class="s2">                        `pooled_prompt_embeds` from the same text encoder </span><span class="se">\</span>
<span class="s2">                            that was used to generate `prompt_embeds`.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">negative_prompt_embeds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negative_pooled_prompt_embeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;If `negative_prompt_embeds` are provided, </span><span class="se">\</span>
<span class="s2">                    `negative_pooled_prompt_embeds` also have to be passed. </span><span class="se">\</span>
<span class="s2">                        Make sure to generate `negative_pooled_prompt_embeds`</span><span class="se">\</span>
<span class="s2">                             from the same text encoder that was used to </span><span class="se">\</span>
<span class="s2">                                generate `negative_prompt_embeds`.&quot;</span>
            <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_and_get_attention_maps_per_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_softmax</span><span class="p">):</span>
        <span class="n">attention_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">aggregate_attention</span><span class="p">(</span>
            <span class="n">from_where</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;up_cross&quot;</span><span class="p">,</span> <span class="s2">&quot;down_cross&quot;</span><span class="p">,</span> <span class="s2">&quot;mid_cross&quot;</span><span class="p">),</span>
            <span class="c1"># from_where=(&quot;up&quot;, &quot;down&quot;),</span>
            <span class="c1"># from_where=(&quot;down&quot;,)</span>
        <span class="p">)</span>
        <span class="n">attention_maps_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_attention_maps_list</span><span class="p">(</span><span class="n">attention_maps</span><span class="o">=</span><span class="n">attention_maps</span><span class="p">,</span> <span class="n">with_softmax</span><span class="o">=</span><span class="n">with_softmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attention_maps_list</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_attention_maps_list</span><span class="p">(</span><span class="n">attention_maps</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">with_softmax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
        <span class="n">attention_maps</span> <span class="o">*=</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="n">with_softmax</span><span class="p">:</span>
            <span class="n">attention_maps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_maps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">attention_maps_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">attention_maps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attention_maps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">attention_maps_list</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">prompt_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">height</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
        <span class="n">denoising_end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">guidance_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">7.5</span><span class="p">,</span>
        <span class="n">negative_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_prompt_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_images_per_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">eta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">generator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">latents</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_prompt_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pooled_prompt_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_pooled_prompt_embeds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pil&quot;</span><span class="p">,</span>
        <span class="n">return_dict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callback_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">cross_attention_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">guidance_rescale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">original_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crops_coords_top_left</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">target_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_original_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">negative_crops_coords_top_left</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">negative_target_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function invoked when calling the pipeline for generation.</span>

<span class="sd">        Args:</span>
<span class="sd">            prompt (`str` or `List[str]`):</span>
<span class="sd">                The prompt or prompts to guide the image generation.</span>
<span class="sd">            height (`int`, *optional*, defaults to</span>
<span class="sd">            self.unet.config.sample_size * self.vae_scale_factor):</span>
<span class="sd">                The height in pixels of the generated image.</span>
<span class="sd">            width (`int`, *optional*, defaults to</span>
<span class="sd">            self.unet.config.sample_size * self.vae_scale_factor):</span>
<span class="sd">                The width in pixels of the generated image.</span>
<span class="sd">            num_inference_steps (`int`, *optional*, defaults to 50):</span>
<span class="sd">                The number of denoising steps. More denoising steps</span>
<span class="sd">                usually lead to a higher quality image at the</span>
<span class="sd">                expense of slower inference.</span>
<span class="sd">            guidance_scale (`float`, *optional*, defaults to 7.5):</span>
<span class="sd">                Guidance scale as defined in [Classifier-Free Diffusion</span>
<span class="sd">                Guidance](https://arxiv.org/abs/2207.12598).</span>
<span class="sd">                `guidance_scale` is defined as `w` of equation 2. of [Imagen</span>
<span class="sd">                Paper](https://arxiv.org/pdf/2205.11487.pdf). Guidance scale</span>
<span class="sd">                 is enabled by setting `guidance_scale &gt;</span>
<span class="sd">                1`. Higher guidance scale encourages to generate images that</span>
<span class="sd">                are closely linked to the text `prompt`,</span>
<span class="sd">                usually at the expense of lower image quality.</span>
<span class="sd">            negative_prompt (`str` or `List[str]`, *optional*):</span>
<span class="sd">                The prompt or prompts not to guide the image generation.</span>
<span class="sd">                Ignored when not using guidance (i.e., ignored</span>
<span class="sd">                if `guidance_scale` is less than `1`).</span>
<span class="sd">            num_images_per_prompt (`int`, *optional*, defaults to 1):</span>
<span class="sd">                The number of images to generate per prompt.</span>
<span class="sd">            eta (`float`, *optional*, defaults to 0.0):</span>
<span class="sd">                Corresponds to parameter eta (Œ∑) in the DDIM paper:</span>
<span class="sd">                https://arxiv.org/abs/2010.02502. Only applies to</span>
<span class="sd">                [`schedulers.DDIMScheduler`], will be ignored for others.</span>
<span class="sd">            generator (`torch.Generator`, *optional*):</span>
<span class="sd">                One or a list of [torch generator(s)](https://pytorch.org/</span>
<span class="sd">                docs/stable/generated/torch.Generator.html)</span>
<span class="sd">                to make generation deterministic.</span>
<span class="sd">            latents (`torch.FloatTensor`, *optional*):</span>
<span class="sd">                Pre-generated noisy latents, sampled from a Gaussian</span>
<span class="sd">                distribution, to be used as inputs for image</span>
<span class="sd">                generation. Can be used to tweak the same generation</span>
<span class="sd">                with different prompts. If not provided, a latents</span>
<span class="sd">                tensor will ge generated by sampling using the supplied</span>
<span class="sd">                random `generator`.</span>
<span class="sd">            output_type (`str`, *optional*, defaults to `&quot;pil&quot;`):</span>
<span class="sd">                The output format of the generate image. Choose between</span>
<span class="sd">                [PIL](https://pillow.readthedocs.io/en/stable/):</span>
<span class="sd">                `PIL.Image.Image` or `np.array`.</span>
<span class="sd">            return_dict (`bool`, *optional*, defaults to `True`):</span>
<span class="sd">                Whether or not to return a [`~pipelines.stable_diffusion.</span>
<span class="sd">                StableDiffusionPipelineOutput`] instead of a</span>
<span class="sd">                plain tuple.</span>
<span class="sd">            callback (`Callable`, *optional*):</span>
<span class="sd">                A function that will be called every `callback_steps`</span>
<span class="sd">                steps during inference. The function will be</span>
<span class="sd">                called with the following arguments: `callback(step: int,</span>
<span class="sd">                 timestep: int, latents: torch.FloatTensor)`.</span>
<span class="sd">            callback_steps (`int`, *optional*, defaults to 1):</span>
<span class="sd">                The frequency at which the `callback` function will be</span>
<span class="sd">                called. If not specified, the callback will be</span>
<span class="sd">                called at every step.</span>
<span class="sd">            cross_attention_kwargs (`dict`, *optional*):</span>
<span class="sd">                A kwargs dictionary that if specified is passed along to</span>
<span class="sd">                the [`AttentionProcessor`] as defined in</span>
<span class="sd">                [`self.processor`](https://github.com/huggingface/diffusers/</span>
<span class="sd">                blob/main/src/diffusers/models/attention_processor.py).</span>

<span class="sd">                The keyword arguments to configure the edit are:</span>
<span class="sd">                - edit_type (`str`). The edit type to apply. Can be either of</span>
<span class="sd">                `replace`, `refine`, `reweight`.</span>
<span class="sd">                - n_cross_replace (`int`): Number of diffusion steps in which</span>
<span class="sd">                cross attention should be replaced</span>
<span class="sd">                - n_self_replace (`int`): Number of diffusion steps in which</span>
<span class="sd">                self attention should be replaced</span>
<span class="sd">                - local_blend_words(`List[str]`, *optional*, default to</span>
<span class="sd">                 `None`): Determines which area should be</span>
<span class="sd">                  changed. If None, then the whole image can be changed.</span>
<span class="sd">                - equalizer_words(`List[str]`, *optional*, default to</span>
<span class="sd">                `None`): Required for edit type `reweight`.</span>
<span class="sd">                  Determines which words should be enhanced.</span>
<span class="sd">                - equalizer_strengths (`List[float]`, *optional*, default</span>
<span class="sd">                 to `None`) Required for edit type `reweight`.</span>
<span class="sd">                  Determines which how much the words in `equalizer_words`</span>
<span class="sd">                   should be enhanced.</span>

<span class="sd">            guidance_rescale (`float`, *optional*, defaults to 0.0):</span>
<span class="sd">                Guidance rescale factor from [Common Diffusion Noise</span>
<span class="sd">                Schedules and Sample Steps are</span>
<span class="sd">                Flawed](https://arxiv.org/pdf/2305.08891.pdf). Guidance</span>
<span class="sd">                rescale factor should fix overexposure when</span>
<span class="sd">                using zero terminal SNR.</span>

<span class="sd">        Returns:</span>
<span class="sd">            [`~pipelines.stable_diffusion.StableDiffusionPipelineOutput`]</span>
<span class="sd">            or `tuple`:</span>
<span class="sd">            [`~pipelines.stable_diffusion.StableDiffusionPipelineOutput`]</span>
<span class="sd">            if `return_dict` is True, otherwise a `tuple.</span>
<span class="sd">            When returning a tuple, the first element is a list with the</span>
<span class="sd">            generated images, and the second element is a</span>
<span class="sd">            list of `bool`s denoting whether the corresponding generated</span>
<span class="sd">            image likely represents &quot;not-safe-for-work&quot;</span>
<span class="sd">            (nsfw) content, according to the `safety_checker`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 0. Default height and width to unet</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae_scale_factor</span>

        <span class="n">original_size</span> <span class="o">=</span> <span class="n">original_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">target_size</span> <span class="o">=</span> <span class="n">target_size</span> <span class="ow">or</span> <span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attn_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attn_res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="mi">32</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span> <span class="o">=</span> <span class="n">attn_res</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">create_controller</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">cross_attention_kwargs</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_attention_control</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">)</span>  <span class="c1"># add attention controller</span>

        <span class="c1"># 1. Check inputs. Raise error if not correct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span>
            <span class="n">prompt_2</span><span class="p">,</span>
            <span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">callback_steps</span><span class="p">,</span>
            <span class="n">negative_prompt</span><span class="p">,</span>
            <span class="n">negative_prompt_2</span><span class="p">,</span>
            <span class="n">prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_prompt_embeds</span><span class="p">,</span>
            <span class="n">pooled_prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_pooled_prompt_embeds</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 2. Define call parameters</span>
        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">prompt_embeds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_device</span>
        <span class="c1"># here `guidance_scale` is defined analog to the guidance weight</span>
        <span class="c1"># `w` of equation (2)</span>
        <span class="c1"># of the Imagen paper: https://arxiv.org/pdf/2205.11487.pdf .</span>
        <span class="c1"># `guidance_scale = 1`</span>
        <span class="c1"># corresponds to doing no classifier free guidance.</span>
        <span class="n">do_classifier_free_guidance</span> <span class="o">=</span> <span class="n">guidance_scale</span> <span class="o">&gt;</span> <span class="mf">1.0</span>

        <span class="c1"># 3. Encode input prompt</span>
        <span class="n">text_encoder_lora_scale</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scale&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">cross_attention_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="n">prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_prompt_embeds</span><span class="p">,</span>
            <span class="n">pooled_prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_pooled_prompt_embeds</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_prompt</span><span class="p">(</span>
            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
            <span class="n">prompt_2</span><span class="o">=</span><span class="n">prompt_2</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">num_images_per_prompt</span><span class="o">=</span><span class="n">num_images_per_prompt</span><span class="p">,</span>
            <span class="n">do_classifier_free_guidance</span><span class="o">=</span><span class="n">do_classifier_free_guidance</span><span class="p">,</span>
            <span class="n">negative_prompt</span><span class="o">=</span><span class="n">negative_prompt</span><span class="p">,</span>
            <span class="n">negative_prompt_2</span><span class="o">=</span><span class="n">negative_prompt_2</span><span class="p">,</span>
            <span class="n">prompt_embeds</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_prompt_embeds</span><span class="o">=</span><span class="n">negative_prompt_embeds</span><span class="p">,</span>
            <span class="n">pooled_prompt_embeds</span><span class="o">=</span><span class="n">pooled_prompt_embeds</span><span class="p">,</span>
            <span class="n">negative_pooled_prompt_embeds</span><span class="o">=</span><span class="n">negative_pooled_prompt_embeds</span><span class="p">,</span>
            <span class="n">lora_scale</span><span class="o">=</span><span class="n">text_encoder_lora_scale</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># 4. Prepare timesteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">set_timesteps</span><span class="p">(</span><span class="n">num_inference_steps</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">timesteps</span>

        <span class="c1"># 5. Prepare latent variables</span>
        <span class="n">num_channels_latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">in_channels</span>
        <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_latents</span><span class="p">(</span>
            <span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_images_per_prompt</span><span class="p">,</span>
            <span class="n">num_channels_latents</span><span class="p">,</span>
            <span class="n">height</span><span class="p">,</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="n">prompt_embeds</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="p">,</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">latents</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 6. Prepare extra step kwargs. TODO: Logic should</span>
        <span class="c1"># ideally just be moved out of the pipeline</span>
        <span class="n">extra_step_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_extra_step_kwargs</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>

        <span class="c1"># 7. Prepare added time ids &amp; embeddings</span>
        <span class="n">add_text_embeds</span> <span class="o">=</span> <span class="n">pooled_prompt_embeds</span>
        <span class="n">add_time_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_add_time_ids</span><span class="p">(</span>
            <span class="n">original_size</span><span class="p">,</span>
            <span class="n">crops_coords_top_left</span><span class="p">,</span>
            <span class="n">target_size</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">text_encoder_projection_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">text_encoder_2</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">projection_dim</span><span class="p">,</span>  <span class="c1"># if none should be changed to enc1</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">negative_original_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">negative_target_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">negative_add_time_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_add_time_ids</span><span class="p">(</span>
                <span class="n">negative_original_size</span><span class="p">,</span>
                <span class="n">negative_crops_coords_top_left</span><span class="p">,</span>
                <span class="n">negative_target_size</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">negative_add_time_ids</span> <span class="o">=</span> <span class="n">add_time_ids</span>

        <span class="k">if</span> <span class="n">do_classifier_free_guidance</span><span class="p">:</span>
            <span class="n">prompt_embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">negative_prompt_embeds</span><span class="p">,</span> <span class="n">prompt_embeds</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">add_text_embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">negative_pooled_prompt_embeds</span><span class="p">,</span> <span class="n">add_text_embeds</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">add_time_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">negative_add_time_ids</span><span class="p">,</span> <span class="n">add_time_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">prompt_embeds</span> <span class="o">=</span> <span class="n">prompt_embeds</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">add_text_embeds</span> <span class="o">=</span> <span class="n">add_text_embeds</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">add_time_ids</span> <span class="o">=</span> <span class="n">add_time_ids</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_images_per_prompt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 8. Denoising loop</span>
        <span class="n">num_warmup_steps</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_inference_steps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 7.1 Apply denoising_end</span>
        <span class="k">if</span> <span class="n">denoising_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">denoising_end</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">denoising_end</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">denoising_end</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">discrete_timestep_cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">round</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_train_timesteps</span>
                    <span class="o">-</span> <span class="p">(</span><span class="n">denoising_end</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_train_timesteps</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">num_inference_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">ts</span><span class="p">:</span> <span class="n">ts</span> <span class="o">&gt;=</span> <span class="n">discrete_timestep_cutoff</span><span class="p">,</span> <span class="n">timesteps</span><span class="p">)))</span>
            <span class="n">timesteps</span> <span class="o">=</span> <span class="n">timesteps</span><span class="p">[:</span><span class="n">num_inference_steps</span><span class="p">]</span>

        <span class="n">added_cond_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text_embeds&quot;</span><span class="p">:</span> <span class="n">add_text_embeds</span><span class="p">,</span> <span class="s2">&quot;time_ids&quot;</span><span class="p">:</span> <span class="n">add_time_ids</span><span class="p">}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_inference_steps</span><span class="p">)</span> <span class="k">as</span> <span class="n">progress_bar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timesteps</span><span class="p">):</span>
                <span class="c1"># expand the latents if we are doing classifier free guidance</span>
                <span class="n">latent_model_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">latents</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">do_classifier_free_guidance</span> <span class="k">else</span> <span class="n">latents</span>
                <span class="n">latent_model_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">scale_model_input</span><span class="p">(</span><span class="n">latent_model_input</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

                <span class="c1"># predict the noise residual</span>
                <span class="n">noise_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="p">(</span>
                    <span class="n">latent_model_input</span><span class="p">,</span>
                    <span class="n">t</span><span class="p">,</span>
                    <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="n">prompt_embeds</span><span class="p">,</span>
                    <span class="n">added_cond_kwargs</span><span class="o">=</span><span class="n">added_cond_kwargs</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sample</span>

                <span class="c1"># perform guidance</span>
                <span class="k">if</span> <span class="n">do_classifier_free_guidance</span><span class="p">:</span>
                    <span class="n">noise_pred_uncond</span><span class="p">,</span> <span class="n">noise_pred_text</span> <span class="o">=</span> <span class="n">noise_pred</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">noise_pred</span> <span class="o">=</span> <span class="n">noise_pred_uncond</span> <span class="o">+</span> <span class="n">guidance_scale</span> <span class="o">*</span> <span class="p">(</span><span class="n">noise_pred_text</span> <span class="o">-</span> <span class="n">noise_pred_uncond</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">do_classifier_free_guidance</span> <span class="ow">and</span> <span class="n">guidance_rescale</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c1"># Based on 3.4. in https://arxiv.org/pdf/2305.08891.pdf</span>
                    <span class="n">noise_pred</span> <span class="o">=</span> <span class="n">rescale_noise_cfg</span><span class="p">(</span><span class="n">noise_pred</span><span class="p">,</span> <span class="n">noise_pred_text</span><span class="p">,</span> <span class="n">guidance_rescale</span><span class="o">=</span><span class="n">guidance_rescale</span><span class="p">)</span>

                <span class="c1"># compute the previous noisy sample x_t -&gt; x_t-1</span>
                <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">noise_pred</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">latents</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_step_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">prev_sample</span>

                <span class="c1"># step callback</span>
                <span class="n">latents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">step_callback</span><span class="p">(</span><span class="n">latents</span><span class="p">)</span>

                <span class="c1"># call the callback, if provided</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesteps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">num_warmup_steps</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">callback_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">step_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">callback</span><span class="p">(</span><span class="n">step_idx</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">latents</span><span class="p">)</span>

        <span class="c1"># 8. Post-processing</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span>
            <span class="c1"># make sure the VAE is in float32 mode, as it overflows in float16</span>
            <span class="n">needs_upcasting</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">force_upcast</span>

            <span class="k">if</span> <span class="n">needs_upcasting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">upcast_vae</span><span class="p">()</span>
                <span class="n">latents</span> <span class="o">=</span> <span class="n">latents</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">post_quant_conv</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">latents</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scaling_factor</span><span class="p">,</span> <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># cast back to fp16 if needed</span>
            <span class="k">if</span> <span class="n">needs_upcasting</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vae</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">latents</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_type</span> <span class="o">==</span> <span class="s2">&quot;latent&quot;</span><span class="p">:</span>
            <span class="c1"># apply watermark if available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watermark</span><span class="o">.</span><span class="n">apply_watermark</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_processor</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="n">output_type</span><span class="p">)</span>

        <span class="c1"># Offload all models</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maybe_free_model_hooks</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">image</span><span class="p">,)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">diffusers.pipelines.stable_diffusion_xl.pipeline_output</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
            <span class="n">StableDiffusionXLPipelineOutput</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">StableDiffusionXLPipelineOutput</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>

<div class="viewcode-block" id="Prompt2PromptPipeline.register_attention_control">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.Prompt2PromptPipeline.register_attention_control">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_attention_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">):</span>
        <span class="n">attn_procs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cross_att_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">attn_processors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;attn1.processor&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cross_attention_dim</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mid_block&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">place_in_unet</span> <span class="o">=</span> <span class="s2">&quot;mid&quot;</span>
            <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;up_blocks&quot;</span><span class="p">):</span>
                <span class="n">block_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;up_blocks.&quot;</span><span class="p">)])</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">))[</span><span class="n">block_id</span><span class="p">]</span>
                <span class="n">place_in_unet</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>
            <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;down_blocks&quot;</span><span class="p">):</span>
                <span class="n">block_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;down_blocks.&quot;</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">block_out_channels</span><span class="p">[</span><span class="n">block_id</span><span class="p">]</span>
                <span class="n">place_in_unet</span> <span class="o">=</span> <span class="s2">&quot;down&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cross_att_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">attn_procs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">P2PCrossAttnProcessor</span><span class="p">(</span><span class="n">controller</span><span class="o">=</span><span class="n">controller</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="o">=</span><span class="n">place_in_unet</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unet</span><span class="o">.</span><span class="n">set_attn_processor</span><span class="p">(</span><span class="n">attn_procs</span><span class="p">)</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">num_att_layers</span> <span class="o">=</span> <span class="n">cross_att_count</span></div>
</div>



<span class="c1"># Copied from https://github.com/RoyiRa/prompt-to-prompt-with-sdxl</span>
<div class="viewcode-block" id="P2PCrossAttnProcessor">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.P2PCrossAttnProcessor">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">P2PCrossAttnProcessor</span><span class="p">:</span>
<div class="viewcode-block" id="P2PCrossAttnProcessor.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.P2PCrossAttnProcessor.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">place_in_unet</span> <span class="o">=</span> <span class="n">place_in_unet</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">:</span> <span class="n">diffusers</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">attention</span><span class="o">.</span><span class="n">Attention</span><span class="p">,</span> <span class="n">hidden_states</span><span class="p">,</span> <span class="n">encoder_hidden_states</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attention_mask</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">hidden_states</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">prepare_attention_mask</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">to_q</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

        <span class="n">is_cross</span> <span class="o">=</span> <span class="n">encoder_hidden_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">encoder_hidden_states</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoder_hidden_states</span> <span class="o">=</span> <span class="n">encoder_hidden_states</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">encoder_hidden_states</span> <span class="o">=</span> <span class="n">hidden_states</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">to_k</span><span class="p">(</span><span class="n">encoder_hidden_states</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">to_v</span><span class="p">(</span><span class="n">encoder_hidden_states</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">head_to_batch_dim</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">head_to_batch_dim</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">head_to_batch_dim</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">attention_probs</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">get_attention_scores</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">)</span>

        <span class="c1"># one line change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">place_in_unet</span><span class="p">)</span>

        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">attention_probs</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">batch_to_head_dim</span><span class="p">(</span><span class="n">hidden_states</span><span class="p">)</span>

        <span class="c1"># linear proj</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">to_out</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">hidden_states</span><span class="p">)</span>
        <span class="c1"># dropout</span>
        <span class="n">hidden_states</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">to_out</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">hidden_states</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hidden_states</span></div>



<div class="viewcode-block" id="AttentionControl">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionControl</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionControl.step_callback">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl.step_callback">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x_t</span></div>


<div class="viewcode-block" id="AttentionControl.between_steps">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl.between_steps">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">between_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">num_uncond_att_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="AttentionControl.forward">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl.forward">[ÊñáÊ°£]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_uncond_att_layers</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attn</span><span class="p">[</span><span class="n">h</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">attn</span><span class="p">[</span><span class="n">h</span> <span class="o">//</span> <span class="mi">2</span> <span class="p">:],</span> <span class="n">is_cross</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_att_layers</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_uncond_att_layers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">between_steps</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">attn</span>

<div class="viewcode-block" id="AttentionControl.reset">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl.reset">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="AttentionControl.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControl.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_att_layers</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur_att_layer</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span> <span class="o">=</span> <span class="n">attn_res</span></div>
</div>



<div class="viewcode-block" id="create_controller">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.create_controller">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_controller</span><span class="p">(</span>
    <span class="n">prompts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cross_attention_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">num_inference_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AttentionControl</span><span class="p">:</span>
    <span class="n">edit_type</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edit_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">local_blend_words</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;local_blend_words&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">equalizer_words</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equalizer_words&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">equalizer_strengths</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equalizer_strengths&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">n_cross_replace</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_cross_replace&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
    <span class="n">n_self_replace</span> <span class="o">=</span> <span class="n">cross_attention_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_self_replace&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># only replace</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AttentionReplace</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># replace + localblend</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">LocalBlend</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">local_blend_words</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AttentionReplace</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">lb</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># only refine</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;refine&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">AttentionRefine</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># refine + localblend</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;refine&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">LocalBlend</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">local_blend_words</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AttentionRefine</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">lb</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># only reweight</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;reweight&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">equalizer_words</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">equalizer_strengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;To use reweight edit, please specify equalizer_words </span><span class="se">\</span>
<span class="s2">            and equalizer_strengths.&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">equalizer_words</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">equalizer_strengths</span>
        <span class="p">),</span> <span class="s2">&quot;equalizer_words and equalizer_strengths must be of same length.&quot;</span>
        <span class="n">equalizer</span> <span class="o">=</span> <span class="n">get_equalizer</span><span class="p">(</span><span class="n">prompts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">equalizer_words</span><span class="p">,</span> <span class="n">equalizer_strengths</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AttentionReweight</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">equalizer</span><span class="o">=</span><span class="n">equalizer</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># reweight and localblend</span>
    <span class="k">if</span> <span class="n">edit_type</span> <span class="o">==</span> <span class="s2">&quot;reweight&quot;</span> <span class="ow">and</span> <span class="n">local_blend_words</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">equalizer_words</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">equalizer_strengths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">),</span> <span class="s2">&quot;To use reweight edit, please specify equalizer_words </span><span class="se">\</span>
<span class="s2">            and equalizer_strengths.&quot;</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">equalizer_words</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">equalizer_strengths</span>
        <span class="p">),</span> <span class="s2">&quot;equalizer_words and equalizer_strengths must be of same length.&quot;</span>
        <span class="n">equalizer</span> <span class="o">=</span> <span class="n">get_equalizer</span><span class="p">(</span><span class="n">prompts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">equalizer_words</span><span class="p">,</span> <span class="n">equalizer_strengths</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">LocalBlend</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">local_blend_words</span><span class="p">,</span> <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AttentionReweight</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span>
            <span class="n">num_inference_steps</span><span class="p">,</span>
            <span class="n">n_cross_replace</span><span class="p">,</span>
            <span class="n">n_self_replace</span><span class="p">,</span>
            <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">equalizer</span><span class="o">=</span><span class="n">equalizer</span><span class="p">,</span>
            <span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">,</span>
            <span class="n">local_blend</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Edit type </span><span class="si">{</span><span class="n">edit_type</span><span class="si">}</span><span class="s2"> not recognized. Use one of: </span><span class="se">\</span>
<span class="s2">            replace, refine, reweight.&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="EmptyControl">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.EmptyControl">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EmptyControl</span><span class="p">(</span><span class="n">AttentionControl</span><span class="p">):</span>
<div class="viewcode-block" id="EmptyControl.forward">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.EmptyControl.forward">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attn</span></div>
</div>



<div class="viewcode-block" id="AttentionStore">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionStore</span><span class="p">(</span><span class="n">AttentionControl</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionStore.get_empty_store">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.get_empty_store">[ÊñáÊ°£]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_empty_store</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;down_cross&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;mid_cross&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;up_cross&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;down_self&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;mid_self&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;up_self&quot;</span><span class="p">:</span> <span class="p">[]}</span></div>


<div class="viewcode-block" id="AttentionStore.forward">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.forward">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">place_in_unet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="s1">&#39;cross&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">is_cross</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;self&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>  <span class="c1"># avoid memory overhead</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attn</span></div>


<div class="viewcode-block" id="AttentionStore.between_steps">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.between_steps">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">between_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_store</span><span class="p">()</span></div>


<div class="viewcode-block" id="AttentionStore.get_average_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.get_average_attention">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_average_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">average_attention</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">average_attention</span></div>


<div class="viewcode-block" id="AttentionStore.reset">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.reset">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="AttentionStore.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionStore.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionStore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attn_res</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_store</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span> <span class="o">=</span> <span class="p">{}</span></div>
</div>



<div class="viewcode-block" id="LocalBlend">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.LocalBlend">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">LocalBlend</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">attention_store</span><span class="p">):</span>
        <span class="c1"># note that this code works on the latent level!</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># maps = attention_store[&quot;down_cross&quot;][2:4] +</span>
        <span class="c1"># attention_store[&quot;up_cross&quot;][:3]</span>
        <span class="c1"># These are the numbers because we want to take layers</span>
        <span class="c1"># that are 256 x 256,</span>
        <span class="c1"># I think this can be changed to something smarter...like,</span>
        <span class="c1"># get all attentions where thesecond dim is self.attn_res[0]</span>
        <span class="c1">#  * self.attn_res[1] in up and down cross.</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">m</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">attention_store</span><span class="p">[</span><span class="s2">&quot;down_cross&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attention_store</span><span class="p">[</span><span class="s2">&quot;mid_cross&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">attention_store</span><span class="p">[</span><span class="s2">&quot;up_cross&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_layers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_words</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">maps</span>
        <span class="p">]</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">(</span><span class="n">maps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_layers</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># since alpha_layers is all 0s except where we edit, the</span>
        <span class="c1"># product zeroes out all but what we change. Then, the sum</span>
        <span class="c1">#  adds the values of the original and what we edit. Then,</span>
        <span class="c1">#  we average across dim=1, which is the number of layers.</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">maps</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">x_t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">/</span> <span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_t</span> <span class="o">-</span> <span class="n">x_t</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># x_t[:1] is the original image. mask*(x_t - x_t[:1])</span>
        <span class="c1">#  zeroes out the original image and removes the difference</span>
        <span class="c1">#  between the original and each image we are generating</span>
        <span class="c1">#  (mostly just one). Then, it applies the mask on the image.</span>
        <span class="c1">#  That is, it&#39;s only keeping the cells we want to generate.</span>
        <span class="k">return</span> <span class="n">x_t</span>

<div class="viewcode-block" id="LocalBlend.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.LocalBlend.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">words</span><span class="p">:</span> <span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_num_words</span> <span class="o">=</span> <span class="mi">77</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span> <span class="o">=</span> <span class="n">attn_res</span>

        <span class="n">alpha_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_num_words</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">words_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">words</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">words_</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">words_</span> <span class="o">=</span> <span class="p">[</span><span class="n">words_</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words_</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">get_word_inds</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
                <span class="n">alpha_layers</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_layers</span> <span class="o">=</span> <span class="n">alpha_layers</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="c1"># a one-hot vector where the 1s are the words</span>
        <span class="c1"># we modify (source and target)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span></div>
</div>



<div class="viewcode-block" id="AttentionControlEdit">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionControlEdit</span><span class="p">(</span><span class="n">AttentionStore</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionControlEdit.step_callback">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit.step_callback">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">step_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_blend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_blend</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_store</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_t</span></div>


<div class="viewcode-block" id="AttentionControlEdit.replace_self_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit.replace_self_attention">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_self_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">att_replace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attn_base</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">att_replace</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">attn_base</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">att_replace</span></div>


<div class="viewcode-block" id="AttentionControlEdit.replace_cross_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit.replace_cross_attention">[ÊñáÊ°£]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_cross_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="AttentionControlEdit.forward">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit.forward">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionControlEdit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">is_cross</span><span class="p">,</span> <span class="n">place_in_unet</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_cross</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_self_replace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_self_replace</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">attn_base</span><span class="p">,</span> <span class="n">attn_replace</span> <span class="o">=</span> <span class="n">attn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attn</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">is_cross</span><span class="p">:</span>
                <span class="n">alpha_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_replace_alpha</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_step</span><span class="p">]</span>
                <span class="n">attn_replace_new</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">replace_cross_attention</span><span class="p">(</span><span class="n">attn_base</span><span class="p">,</span> <span class="n">attn_replace</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_words</span>
                    <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha_words</span><span class="p">)</span> <span class="o">*</span> <span class="n">attn_replace</span>
                <span class="p">)</span>
                <span class="n">attn</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">attn_replace_new</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attn</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_self_attention</span><span class="p">(</span><span class="n">attn_base</span><span class="p">,</span> <span class="n">attn_replace</span><span class="p">)</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">attn</span></div>


<div class="viewcode-block" id="AttentionControlEdit.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionControlEdit.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompts</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cross_replace_steps</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span>
        <span class="n">self_replace_steps</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">local_blend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LocalBlend</span><span class="p">],</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">device</span><span class="p">,</span>
        <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionControlEdit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">attn_res</span><span class="o">=</span><span class="n">attn_res</span><span class="p">)</span>
        <span class="c1"># add tokenizer and device here</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_replace_alpha</span> <span class="o">=</span> <span class="n">get_time_words_attention_alpha</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">self_replace_steps</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">self_replace_steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self_replace_steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_self_replace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="n">self_replace_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_steps</span> <span class="o">*</span> <span class="n">self_replace_steps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_blend</span> <span class="o">=</span> <span class="n">local_blend</span></div>
</div>



<div class="viewcode-block" id="AttentionReplace">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReplace">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionReplace</span><span class="p">(</span><span class="n">AttentionControlEdit</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionReplace.replace_cross_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReplace.replace_cross_attention">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_cross_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;hpw,bwn-&gt;bhpn&quot;</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">)</span></div>


<div class="viewcode-block" id="AttentionReplace.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReplace.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompts</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cross_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">self_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">local_blend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LocalBlend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionReplace</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">,</span> <span class="n">self_replace_steps</span><span class="p">,</span> <span class="n">local_blend</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">get_replacement_mapper</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="AttentionRefine">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionRefine">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionRefine</span><span class="p">(</span><span class="n">AttentionControlEdit</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionRefine.replace_cross_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionRefine.replace_cross_attention">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_cross_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">):</span>
        <span class="n">attn_base_replace</span> <span class="o">=</span> <span class="n">attn_base</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">attn_replace</span> <span class="o">=</span> <span class="n">attn_base_replace</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span> <span class="o">+</span> <span class="n">att_replace</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attn_replace</span></div>


<div class="viewcode-block" id="AttentionRefine.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionRefine.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompts</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cross_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">self_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">local_blend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LocalBlend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionRefine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">,</span> <span class="n">self_replace_steps</span><span class="p">,</span> <span class="n">local_blend</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="n">get_refinement_mapper</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">alphas</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphas</span> <span class="o">=</span> <span class="n">alphas</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">alphas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">alphas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="AttentionReweight">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReweight">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AttentionReweight</span><span class="p">(</span><span class="n">AttentionControlEdit</span><span class="p">):</span>
<div class="viewcode-block" id="AttentionReweight.replace_cross_attention">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReweight.replace_cross_attention">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">replace_cross_attention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_controller</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attn_base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_controller</span><span class="o">.</span><span class="n">replace_cross_attention</span><span class="p">(</span><span class="n">attn_base</span><span class="p">,</span> <span class="n">att_replace</span><span class="p">)</span>
        <span class="n">attn_replace</span> <span class="o">=</span> <span class="n">attn_base</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">equalizer</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">attn_replace</span></div>


<div class="viewcode-block" id="AttentionReweight.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.AttentionReweight.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompts</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">cross_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">self_replace_steps</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">equalizer</span><span class="p">,</span>
        <span class="n">local_blend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LocalBlend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">controller</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AttentionControlEdit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">attn_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttentionReweight</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">prompts</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">,</span> <span class="n">self_replace_steps</span><span class="p">,</span> <span class="n">local_blend</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">attn_res</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equalizer</span> <span class="o">=</span> <span class="n">equalizer</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_controller</span> <span class="o">=</span> <span class="n">controller</span></div>
</div>



<span class="c1"># util functions for all Edits</span>
<div class="viewcode-block" id="update_alpha_time_word">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.update_alpha_time_word">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_alpha_time_word</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">,</span> <span class="n">bounds</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">prompt_ind</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">word_inds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bounds</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">word_inds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">word_inds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">alpha</span><span class="p">[:</span><span class="n">start</span><span class="p">,</span> <span class="n">prompt_ind</span><span class="p">,</span> <span class="n">word_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">prompt_ind</span><span class="p">,</span> <span class="n">word_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">end</span><span class="p">:,</span> <span class="n">prompt_ind</span><span class="p">,</span> <span class="n">word_inds</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">alpha</span></div>



<div class="viewcode-block" id="get_time_words_attention_alpha">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_time_words_attention_alpha">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_time_words_attention_alpha</span><span class="p">(</span>
    <span class="n">prompts</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_num_words</span><span class="o">=</span><span class="mi">77</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cross_replace_steps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cross_replace_steps</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;default_&quot;</span><span class="p">:</span> <span class="n">cross_replace_steps</span><span class="p">}</span>
    <span class="k">if</span> <span class="s2">&quot;default_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cross_replace_steps</span><span class="p">:</span>
        <span class="n">cross_replace_steps</span><span class="p">[</span><span class="s2">&quot;default_&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">alpha_time_words</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_num_words</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">alpha_time_words</span> <span class="o">=</span> <span class="n">update_alpha_time_word</span><span class="p">(</span><span class="n">alpha_time_words</span><span class="p">,</span> <span class="n">cross_replace_steps</span><span class="p">[</span><span class="s2">&quot;default_&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cross_replace_steps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;default_&quot;</span><span class="p">:</span>
            <span class="n">inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_word_inds</span><span class="p">(</span><span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">alpha_time_words</span> <span class="o">=</span> <span class="n">update_alpha_time_word</span><span class="p">(</span><span class="n">alpha_time_words</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
    <span class="n">alpha_time_words</span> <span class="o">=</span> <span class="n">alpha_time_words</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_num_words</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">alpha_time_words</span></div>



<span class="c1"># util functions for LocalBlend and ReplacementEdit</span>
<div class="viewcode-block" id="get_word_inds">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_word_inds">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_word_inds</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">word_place</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
    <span class="n">split_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">word_place</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">word_place</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_text</span><span class="p">)</span> <span class="k">if</span> <span class="n">word_place</span> <span class="o">==</span> <span class="n">word</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">word_place</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">word_place</span> <span class="o">=</span> <span class="p">[</span><span class="n">word_place</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word_place</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">words_encode</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">([</span><span class="n">item</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cur_len</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words_encode</span><span class="p">)):</span>
            <span class="n">cur_len</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words_encode</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ptr</span> <span class="ow">in</span> <span class="n">word_place</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_len</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_text</span><span class="p">[</span><span class="n">ptr</span><span class="p">]):</span>
                <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cur_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>



<span class="c1"># util functions for ReplacementEdit</span>
<div class="viewcode-block" id="get_replacement_mapper_">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_replacement_mapper_">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_replacement_mapper_</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">77</span><span class="p">):</span>
    <span class="n">words_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">words_y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words_x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">words_y</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;attention replacement edit can only be applied </span><span class="se">\</span>
<span class="s2">                on prompts with the same length&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; but prompt A has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">words_x</span><span class="p">)</span><span class="si">}</span><span class="s2"> words and prompt </span><span class="se">\</span>
<span class="s2">                B has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">words_y</span><span class="p">)</span><span class="si">}</span><span class="s2"> words.&quot;</span>
        <span class="p">)</span>
    <span class="n">inds_replace</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words_y</span><span class="p">))</span> <span class="k">if</span> <span class="n">words_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">words_x</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">inds_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_word_inds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds_replace</span><span class="p">]</span>
    <span class="n">inds_target</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_word_inds</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds_replace</span><span class="p">]</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cur_inds</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_len</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max_len</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cur_inds</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_source</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inds_source</span><span class="p">[</span><span class="n">cur_inds</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">inds_source_</span><span class="p">,</span> <span class="n">inds_target_</span> <span class="o">=</span> <span class="n">inds_source</span><span class="p">[</span><span class="n">cur_inds</span><span class="p">],</span> <span class="n">inds_target</span><span class="p">[</span><span class="n">cur_inds</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_source_</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_target_</span><span class="p">):</span>
                <span class="n">mapper</span><span class="p">[</span><span class="n">inds_source_</span><span class="p">,</span> <span class="n">inds_target_</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_target_</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i_t</span> <span class="ow">in</span> <span class="n">inds_target_</span><span class="p">:</span>
                    <span class="n">mapper</span><span class="p">[</span><span class="n">inds_source_</span><span class="p">,</span> <span class="n">i_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio</span>
            <span class="n">cur_inds</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_source_</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_target_</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cur_inds</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds_source</span><span class="p">):</span>
            <span class="n">mapper</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapper</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># return torch.from_numpy(mapper).float()</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_replacement_mapper">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_replacement_mapper">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_replacement_mapper</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">77</span><span class="p">):</span>
    <span class="n">x_seq</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mappers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)):</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">get_replacement_mapper_</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
        <span class="n">mappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mappers</span><span class="p">)</span></div>



<span class="c1"># util functions for ReweightEdit</span>
<div class="viewcode-block" id="get_equalizer">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_equalizer">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_equalizer</span><span class="p">(</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">word_select</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">values</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span> <span class="n">tokenizer</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">word_select</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="n">word_select</span> <span class="o">=</span> <span class="p">(</span><span class="n">word_select</span><span class="p">,)</span>
    <span class="n">equalizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="mi">77</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">word_select</span><span class="p">):</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">get_word_inds</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
        <span class="n">equalizer</span><span class="p">[:,</span> <span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">equalizer</span></div>



<span class="c1"># util functions for RefinementEdit</span>
<div class="viewcode-block" id="ScoreParams">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.ScoreParams">[ÊñáÊ°£]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ScoreParams</span><span class="p">:</span>
<div class="viewcode-block" id="ScoreParams.__init__">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.ScoreParams.__init__">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">mismatch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mismatch</span> <span class="o">=</span> <span class="n">mismatch</span></div>


<div class="viewcode-block" id="ScoreParams.mis_match_char">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.ScoreParams.mis_match_char">[ÊñáÊ°£]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mis_match_char</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mismatch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span></div>
</div>



<div class="viewcode-block" id="get_matrix">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_matrix">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_matrix</span><span class="p">(</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">,</span> <span class="n">gap</span><span class="p">):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">gap</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">size_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">gap</span>
    <span class="k">return</span> <span class="n">matrix</span></div>



<div class="viewcode-block" id="get_traceback_matrix">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_traceback_matrix">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_traceback_matrix</span><span class="p">(</span><span class="n">size_x</span><span class="p">,</span> <span class="n">size_y</span><span class="p">):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">return</span> <span class="n">matrix</span></div>



<div class="viewcode-block" id="global_align">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.global_align">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">global_align</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">score</span><span class="p">):</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">get_matrix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">score</span><span class="o">.</span><span class="n">gap</span><span class="p">)</span>
    <span class="n">trace_back</span> <span class="o">=</span> <span class="n">get_traceback_matrix</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">score</span><span class="o">.</span><span class="n">gap</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">score</span><span class="o">.</span><span class="n">gap</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">score</span><span class="o">.</span><span class="n">mis_match_char</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">diag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">left</span><span class="p">:</span>
                <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">up</span><span class="p">:</span>
                <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">trace_back</span></div>



<div class="viewcode-block" id="get_aligned_sequences">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_aligned_sequences">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_aligned_sequences</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">trace_back</span><span class="p">):</span>
    <span class="n">x_seq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_seq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">mapper_y_to_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">mapper_y_to_x</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">y_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">mapper_y_to_x</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">x_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">y_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">trace_back</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">mapper_y_to_x</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x_seq</span><span class="p">,</span> <span class="n">y_seq</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mapper_y_to_x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_mapper">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_mapper">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_mapper</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">77</span><span class="p">):</span>
    <span class="n">x_seq</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_seq</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">ScoreParams</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">matrix</span><span class="p">,</span> <span class="n">trace_back</span> <span class="o">=</span> <span class="n">global_align</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">y_seq</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
    <span class="n">mapper_base</span> <span class="o">=</span> <span class="n">get_aligned_sequences</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">y_seq</span><span class="p">,</span> <span class="n">trace_back</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">max_len</span><span class="p">)</span>
    <span class="n">alphas</span><span class="p">[:</span> <span class="n">mapper_base</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapper_base</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ne</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="n">mapper</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">mapper</span><span class="p">[:</span> <span class="n">mapper_base</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapper_base</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">mapper</span><span class="p">[</span><span class="n">mapper_base</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_seq</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_seq</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">alphas</span></div>



<div class="viewcode-block" id="get_refinement_mapper">
<a class="viewcode-back" href="../../../../api/data_juicer.ops.common.prompt2prompt_pipeline.html#data_juicer.ops.common.prompt2prompt_pipeline.get_refinement_mapper">[ÊñáÊ°£]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_refinement_mapper</span><span class="p">(</span><span class="n">prompts</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">77</span><span class="p">):</span>
    <span class="n">x_seq</span> <span class="o">=</span> <span class="n">prompts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mappers</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompts</span><span class="p">)):</span>
        <span class="n">mapper</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">get_mapper</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">prompts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span>
        <span class="n">mappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
        <span class="n">alphas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mappers</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">alphas</span><span class="p">)</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      ¬© Copyright 2024, Data-Juicer Team.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Áî± <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.0.4ÂàõÂª∫„ÄÇ
    <br/>
  </p>
</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  ‰ΩøÁî® <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1ÊûÑÂª∫.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>